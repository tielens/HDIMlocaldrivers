---
title: "cleaned up Rmd for manuscript"
output: html_document
---

<br>
<br>

<br>


### Outline:

<br>

#### Part I
(i)	How do plant phenotypic traits affect phytophagous insect abundance and diversity?
* Results mixed effect models using backward selection and likelihood ratio tests:
* Results for simple mixed effect models with single predictor:
(ii)	What host plant traits are drivers of arthropod community composition?
* PERMANOVA
* Results GLMER

<br>

#### Part II
(iii)	What is the importance of Metrosideros polymorpha traits for specific herbivore species?
* Results GLMER, highlighting the 10 most abundant species
(iv)	Are there characteristics that unify herbivore species in their response to host plant traits?
* Results fourth corner


<br>

#### Contents:
<br>
* Loading data & scaling predictors

* Summary stats


(i)
* species richness across predictors (all plant traits)

* insect abundance across predictors/plant traits

* figure abundance & richness across morphotype

(ii)
* nmds figure

* permanova

* glmer model output

(iii)
* glmer figures

(iv)
* traitglm/fourth corner figure

* fourth corner output

* supplemental materials


<br>
<br>


```{r Load_data&packages, echo=FALSE, warning=FALSE, message=FALSE}
rm(list=ls())


library(ggplot2)
library(scales)
library(lattice)
library(vegan)
library(iNEXT)
library(plyr)
library(mvabund)
library(reshape2)
library(lme4)
library(gridExtra)
library(lmerTest)

#try species by site dataset, including leps and coleoptera
setwd("/Users/elsketielens/phd/data/HDIM/branch clipping/data/data for R")
hem<-read.table("hem.sep18.csv", header=TRUE, sep="")

##load other datasets 
setwd("/Users/elsketielens/phd/data/HDIM/branch clipping/data/data for R")
env<- read.table("env site july16.csv", header=TRUE, sep=",")
env<-env[env$vialID%in%rownames(hem),]
setwd("/Users/elsketielens/phd/data/HDIM/branch clipping/data/data for R")
traits<-read.table("trait species july16new.csv", header=T, sep=",")
setwd("/Users/elsketielens/phd/data/HDIM/branch clipping/data/data for R")
leaftraits.full<-read.table("leaf traits july16.csv", header=TRUE, sep=",")


# Subset to only four sites, for both years
env.both<-env[env$site!="ERY",]
env.both<-env.both[env.both$site!=c("TPR"),]
env.both<-env.both[env.both$site!=c("KAIO"),]
env.both<-env.both[env.both$site!=c("THU"),]
env.both<-env.both[env.both$site!=c("LH"),]
env.both<-env.both[env.both$site!=c("LY"),]
env.both<-env.both[env.both$site!=c("L65"),]
env.both<-env.both[env.both$site!=c("KOHY"),]
env.both<-env.both[env.both$site!=c("KOHO"),]
env.both<-env.both[env.both$island=="Hawaii",]

# create env data for 2014
env.2014<-env.both[env.both$sampleyear=="2014",]


# create hem data
hem.both<-hem[rownames(hem)%in%env.both$vialID,]
hem.2014<-hem[rownames(hem)%in%env.2014$vialID,]

## Create traits data 
#traits.both<-traits[rownames(traits)%in%colnames(hem.both),]
traits<-traits[traits$spec_code%in%colnames(hem.2014),]

# exclude species that don't occur in our four sites
hem.both<-hem.both[,colSums(hem.both)>0]
hem.2014<-hem.2014[,colSums(hem.2014)>0]

# remove predators
traits<- traits[traits$spec_code!="NAB_OSC",]
traits<- traits[traits$spec_code!="COC_SP",]
traits<- traits[traits$spec_code!="PHI_SPU",]
#traits.both<-traits[traits$spec_code%in%colnames(hem.both),]    ### only need to do this for 2014 data? because used for fourth corner mostly?

# exclude species for which we don't have trait data. 
hem.both<-hem.both[ ,which( colnames(hem.both) %in% traits$spec_code )]
hem.2014<-hem.2014[ ,which( colnames(hem.2014) %in% traits$spec_code )]

traits<-traits[traits$spec_code%in%colnames(hem.2014),]
rownames(traits)<-traits$spec_code
traits<-traits[,-c(1)]

## There are NA's in the dataset. Remove.
leaftraits.full<-na.omit(leaftraits.full)

#select subset traits to prevent collinearity
leaftraits.full<-merge(leaftraits.full, env[,c(1,10)], by="vialID")
rownames(leaftraits.full)<-leaftraits.full$vialID
leaftraits.full<-leaftraits.full[,c(3,4,6,7,10,11)]
colnames(leaftraits.full)<-c("percN", "percP", "meanSLA", "meanWatercontent", "CN", "morphotype")

## Create leaftraits data (2014 only)
leaftraits<-leaftraits.full[rownames(leaftraits.full)%in%env.2014$vialID,]


env$morphotype<-factor(env$morphotype, levels=c("G", "H", "P"))

# set different level of morphotype as intercept
leaftraits$morphotype<-factor(leaftraits$morphotype, levels=c("H", "G", "P"))

# load gps coordinates
setwd("/Users/elsketielens/phd/data/HDIM/branch clipping/data/data for R")
xy<-read.table("coordinatesHDIM.csv", header=TRUE, sep=",")
xy<-xy[xy$vialID%in%env$vialID,]
xy.2014<-xy[xy$vialID %in% env.2014$vialID,]
xy.both<-xy[xy$vialID %in% env.both$vialID,]
```
<br>

```{r scaling predictors, echo=F}


leaftraits$percN<- scale(leaftraits$percN,center=T,scale=T)
leaftraits$percP<- scale(leaftraits$percP,center=T,scale=T)
leaftraits$meanSLA<- scale(leaftraits$meanSLA,center=T,scale=T)
leaftraits$meanWatercontent<- scale(leaftraits$meanWatercontent,center=T,scale=T)
leaftraits$CN<- scale(leaftraits$CN,center=T,scale=T)

leaftraits.full$percN<- scale(leaftraits.full$percN,center=T,scale=T)
leaftraits.full$percP<- scale(leaftraits.full$percP,center=T,scale=T)
leaftraits.full$meanSLA<- scale(leaftraits.full$meanSLA,center=T,scale=T)
leaftraits.full$meanWatercontent<- scale(leaftraits.full$meanWatercontent,center=T,scale=T)
leaftraits.full$CN<- scale(leaftraits.full$CN,center=T,scale=T)

env.2014$DW<-offset(scale(env.2014$DW, scale=T, center=T))
env.both$DW<-offset(scale(env.both$DW, scale=T, center=T))
```



#### Summary stats




```{r Summary}

# number of trees sampled 2014
nrow(hem.2014)
# number of tree sampled for both years
nrow(hem.both)
# total number of individuals
sum(rowSums(hem.both))
# number of taxa
ncol(hem.both)

# trees per morphotype
# glabrous:
nrow(hem.both[env.both$morphotype=="G",])
# pubescent 
nrow(hem.both[env.both$morphotype=="P",])
# hybrid
nrow(hem.both[env.both$morphotype=="H",])

# sampling effort:

# mean and sd overall sampling effort
mean(env.2014$DW)
sd(env.2014$DW)

# mean and sd sampling effort per morphotype:
ddply(env.2014, .(morphotype),summarize, mean=mean(DW), sd=sd(DW))

# do sampling efforts differ between morphotypes?
summary(lm(env.2014$DW~env.2014$morphotype))

#do sampling efforts differ between sites?
ddply(env.2014, .(site),summarize, mean=mean(DW), sd=sd(DW))

summary(lm(env.2014$DW~env.2014$site))
```
<br>


<br>

<br>

#### Part I


##### (i)	How do plant phenotypic traits affect phytophagous insect abundance and diversity?

* species richness across predictors (all plant traits)

* insect abundance across predictors/plant traits

* figure abundance & richness across morphotype













##### NMDS figure

<br>

```{r}
hem.ero<-hem[env$site=="ERO",]
hem.ali<-hem[env$site=="ALI",]
hem.kaiy<-hem[env$site=="KAIY",]
hem.olaa<-hem[env$site=="OLAA",]
hem.kaio<-hem[env$site=="KAIO",]

hem.kai.all<-rbind(hem.kaiy,hem.kaio)
env.kai.all<-rbind(env[env$site=="KAIY",],env[env$site=="KAIO",])



## figure output for draft:

  par(mfrow=c(1,2))

moment<-metaMDS(hem.kai.all, k=3)
mds.fig <- ordiplot(moment, type = "none", main="Kaiholena (n=17)")
points(mds.fig, "sites", pch = 15, cex=1.5,col = "blue", select = env.kai.all$morphotype == "H")
points(mds.fig, "sites", pch = 19, cex=1.5,col = "red", select = env.kai.all$morphotype == "P")
points(mds.fig, "sites", pch = 17, cex=1.5,col = "green", select = env.kai.all$morphotype == "G")
Lab<-c( "Glabrous","Hybrid", "Pubescent")
legend(  "topright", legend=Lab,pch=c(17,15,19),col=c("green","blue", "red", "green"),pt.cex=1.5,cex=0.9,xpd=TRUE)

moment<-metaMDS(hem.olaa, k=3)
mds.fig <- ordiplot(moment, type = "none", main="HAVO Olaa")
points(mds.fig, "sites", pch = 17,cex=1.5, col = "green", select = env[env$site=="OLAA",]$morphotype == "G")
points(mds.fig, "sites", pch = 15,cex=1.5, col = "blue", select = env[env$site=="OLAA",]$morphotype == "H")
Lab<-c("Glabrous","Hybrid", "Pubescent")
color<-c("green","blue", "red","green" )
legend(  "topright", legend=Lab,pch=c(17,15,19),col=c(color),pt.cex=1.5,cex=0.9,xpd=TRUE)







adonis(hem.ali~env[env$site=="ALI",]$morphotype, by="margin")
adonis(hem.kai.all~env.kai.all$morphotype, by="margin")
#adonis(hem.kaiy~env[env$site=="KAIY",]$morphotype, by="margin")
adonis(hem.ero~env[env$site=="ERO",]$morphotype, by="margin")
adonis(hem.olaa~env[env$site=="OLAA",]$morphotype, by="margin")




```

<br>




<br>




#### Figures of richness and abundance per morphotype


```{r}
par(mfrow=c(1,2))


plot(rowSums(hem.both)~factor(env.both$morphotype),  ylab="Abundance", xlab="tree morphotype" )
plot(exp(ChaoShannon(as.data.frame(t(hem.both)), datatype = "abundance")[,2])~factor(env.both$morphotype),  ylab="Exp Estimated Shannon (hill 1)", xlab="tree morphotype" )


#summary(lm(specnumber(trial)~factor(env.trial$morphotype)))
summary(lm(exp(ChaoShannon(as.data.frame(t(hem.both)), datatype = "abundance")[,2])~factor(env.both$morphotype)))
summary(lm(rowSums(hem.both)~factor(env.both$morphotype)))
summary(lm(rowSums(hem.2014)~leaftraits$percP))


par(mfrow=c(1,1))
plot(exp(ChaoShannon(as.data.frame(t(hem.both)), datatype = "abundance")[,2])~env.both$DW,  ylab="exp shannon index (hill 1)", xlab="sampling effort (DW in g)")

plot(rowSums(hem.2014)~leaftraits$percP,  ylab="Insect Abundance", xlab="Foliar Phosphorus Content (%)", pch=16)
```









- glmer figures
- glmer model output
- traitglm/fourth corner figure
- fourth corner output
- supplemental materials










#### (ii) Which plant traits account for herbivore community responses to host-plant phenotype?



<br>

```{r Cor}
# partition variance between environment and spatial

test<-varpart(vegdist(decostand(hem.2014, "hel"), method="bray"), leaftraits[,c(1,2,3,4,6)], xy.2014[,2:3])
test
plot(test)

p<-dbrda(vegdist(decostand(hem.2014, "hel"), method="bray")~leaftraits[,1]+ xy.2014[,2]+xy.2014[,3] + leaftraits[,2] +leaftraits[,3]+leaftraits[,4]+leaftraits[,6] )
p
anova(p)


adonis(hem.2014~env.2014$morphotype+leaftraits$percN+leaftraits$meanWatercontent+leaftraits$meanSLA+leaftraits$percP, by="margin")





```

<br>

#########################################################################################################
#####################                                                               #####################
#####################              Model selection portion                          #####################                         
#####################                                                               #####################
#########################################################################################################
<br>

#### (iii) What plant traits drive diversity and abundance across these four sites?

<br>
##### single predictor models

```{r}
shan<-exp(ChaoShannon(as.data.frame(t(hem.2014)) )[,2])
simps<-1-ChaoSimpson(as.data.frame(t(hem.2014), na.rm=TRUE) )[,2]
tem<-ChaoRichness(as.data.frame(t(hem.2014)))[,2]



anova(lmer(shan~env.2014$morphotype+(1|env.2014$site)+offset(env.2014$DW)))
anova(lmer(shan~leaftraits$percN+(1|env.2014$site)+offset(env.2014$DW)))
# sig nitrogen, F=5.3329, p=0.04213
anova(lmer(shan~leaftraits$percP+(1|env.2014$site)+offset(env.2014$DW)))
anova(lmer(shan~leaftraits$meanSLA+(1|env.2014$site)+offset(env.2014$DW)))
anova(lmer(shan~leaftraits$meanWatercontent+(1|env.2014$site)+offset(env.2014$DW)))


anova(lmer(simps~env.2014$morphotype+(1|env.2014$site)+offset(env.2014$DW)))
anova(lmer(simps~leaftraits$percN+(1|env.2014$site)+offset(env.2014$DW)))
# sig nitrogen F=11.548, p=0.00885
anova(lmer(simps~leaftraits$percP+(1|env.2014$site)+offset(env.2014$DW)))
anova(lmer(simps~leaftraits$meanSLA+(1|env.2014$site)+offset(env.2014$DW)))
anova(lmer(simps~leaftraits$meanWatercontent+(1|env.2014$site)+offset(env.2014$DW)))

anova(lmer(tem~env.2014$morphotype+(1|env.2014$site)+offset(env.2014$DW)))
anova(lmer(tem~leaftraits$percN+(1|env.2014$site)+offset(env.2014$DW)))
anova(lmer(tem~leaftraits$percP+(1|env.2014$site)+offset(env.2014$DW)))
anova(lmer(tem~leaftraits$meanSLA+(1|env.2014$site)+offset(env.2014$DW)))
anova(lmer(tem~leaftraits$meanWatercontent+(1|env.2014$site)+offset(env.2014$DW)))

anova(lmer(rowSums(hem.2014)~env.2014$morphotype+(1|env.2014$site)+offset(env.2014$DW)))
anova(lmer(rowSums(hem.2014)~leaftraits$percN+(1|env.2014$site)+offset(env.2014$DW)))
anova(lmer(rowSums(hem.2014)~leaftraits$percP+(1|env.2014$site)+offset(env.2014$DW)))
## sig phosphorus F=6.2651, p=0.03169
anova(lmer(rowSums(hem.2014)~leaftraits$meanSLA+(1|env.2014$site)+offset(env.2014$DW)))
anova(lmer(rowSums(hem.2014)~leaftraits$meanWatercontent+(1|env.2014$site)+offset(env.2014$DW)))
```



```{r}
#hem.both<-hem.both[,-43]

temp<-hem
temp$vialID<-rownames(hem)
temp<-merge(temp,env[,c(1:3)], by="vialID")
temp<-melt(temp)


trial<-dcast(temp, site+plot~variable, fun.aggregate = sum,value.var="value")

#trial.env<-merge(temp, env[,1:3], by="vialID")
#trial<-dcast(trial.env, site+plot~variable, fun.aggregate = sum,value.var="value")

trial<-trial[trial$site%in%env.both$site,]

#hem<-hem[,-84]
#rowSums(hem[env$site=="KAIY",])

#rowSums(trial[,-c(1:2)])


##################################################

p<-ddply(env, .(site,plot),summarize, DW=sum(DW, na.rm=T))
p<-p[p$site%in%env.both$site,]

env.trial<-trial[,1:2]
env.trial<-unique(merge(env.trial, env[,c(2,3,10)], by=c("site","plot")))
trial<-trial[,-c(1:2)]
trial<-trial[,colSums(trial)>0]

env.trial<-merge(env.trial,p, by=c("site", "plot"))
env.trial$morphotype<-factor(env.trial$morphotype, levels=c("G", "H", "P"))
env.2014$morphotype<-factor(env.2014$morphotype, levels=c("G", "H", "P"))
env.trial$DW<-offset(scale(env.trial$DW, scale=T, center=T))

shan<-exp(ChaoShannon(as.data.frame(t(trial)) )[,2])

mod1<-lmer(shan~env.trial$morphotype+leaftraits$percN+leaftraits$percP+leaftraits$meanSLA+leaftraits$meanWatercontent+(1|env.trial$site)+offset(env.trial$DW))

mod14<-lmer(shan~(1|env.trial$site)+offset(env.trial$DW))
anova(mod1,mod14)

anova(model1,model14)


mod3 = update(mod1, . ~ . -leaftraits$meanWatercontent)
anova(mod1,mod14,mod3)

mod4 = update(mod3, . ~ . -leaftraits$meanSLA)
anova(mod1,mod14,mod3,mod4)
mod4

mod5 = update(mod4, . ~ . -leaftraits$percP)
mod6 = update(mod4, . ~ . -env.trial$morphotype)

anova(mod14,mod4,mod5,mod6)
summary(mod5)

mod7 = update(mod5, . ~ . -env.trial$morphotype)
mod8 = update(mod5, . ~ . -leaftraits$percN)
anova(mod14,mod5,mod7,mod8)
summary(mod5)

# mod 5 is best. compared to  null model chisq 11.037, dAIC=5.04, p=0.01153, 6 dF
anova(mod5,mod14)
plot(mod5)
# fitted vs residuals looks good


pcsq<-sum(resid(mod5,type="pearson")^2)
rdf<-df.residual(mod5)
pchisq(pcsq,rdf,lower.tail=F)
pcsq/rdf




simps<-1-ChaoSimpson(as.data.frame(t(trial), na.rm=TRUE) )[,2]

m1<-lmer(simps~env.trial$morphotype+leaftraits$percN+leaftraits$percP+leaftraits$meanSLA+leaftraits$meanWatercontent+(1|env.trial$site)+offset(env.trial$DW))
m2<-lmer(simps~(1|env.trial$site)+offset(env.trial$DW))
anova(m1,m2)

# adding leaftraits does not improve upon null model Simpson diversity
summary(m2)





# estimated richness
tem<-ChaoRichness(as.data.frame(t(trial)))[,2]

rich1<-lmer(tem~env.trial$morphotype+leaftraits$percN+leaftraits$percP+leaftraits$meanSLA+leaftraits$meanWatercontent+(1|env.trial$site)+offset(env.trial$DW))
rich2<-lmer(tem~(1|env.trial$site)+offset(env.trial$DW))
anova(rich1,rich2)

rich3 = update(rich1, . ~ . -leaftraits$percP)
anova(rich1,rich3)
summary(rich3)

rich4 = update(rich3, . ~ . -leaftraits$meanWatercontent)
anova(rich2,rich3,rich4)

rich5 = update(rich4, . ~ . -leaftraits$meanSLA)
anova(rich2,rich4,rich5)

rich6 = update(rich5, . ~ . -leaftraits$percN)
anova(rich5,rich6)

hist(resid(rich5))
plot(rich5)



# rich 5 best
summary(rich5)
plot(rich5)
# chisq 12.192, dAIC=6.19, p=0.006755
# model has morphotype (sug), percN (NS)

abun1<-lmer(rowSums(trial)~env.trial$morphotype+leaftraits$percN+leaftraits$percP+leaftraits$meanSLA+leaftraits$meanWatercontent+(1|env.trial$site)+offset(env.trial$DW))
abun2<-lmer(rowSums(hem.2014)~(1|env.trial$site)+offset(env.trial$DW))
anova(abun1,abun2)

# null model best


```

<br>


<br>



#### GLMER model selection

```{r}
# dataset with 2014 and 2015 data
hem.both$vialID<-rownames(hem.both)
hem.both.long<-melt(hem.both)
hem.both.long<-merge(env.both, hem.both.long, by="vialID")
leaftraits$vialID<-rownames(leaftraits)
temp<-merge(leaftraits,env[,c(1:3)], by="vialID")
temp<-temp[,-1]   
hem.both.long<-hem.both.long[,-1]
hem.both<-hem.both[,-43]

hem.both.long<-merge(hem.both.long, temp, by=c("site", "plot"))

hem.both.long$percN.standard<-(hem.both.long$percN-mean(hem.both.long$percN))/sd(hem.both.long$percN)
hem.both.long$percP.standard<-(hem.both.long$percP-mean(hem.both.long$percP))/sd(hem.both.long$percP)
hem.both.long$meanSLA.standard<-(hem.both.long$meanSLA-mean(hem.both.long$meanSLA))/sd(hem.both.long$meanSLA)
hem.both.long$meanWatercontent.standard<-(hem.both.long$meanWatercontent-mean(hem.both.long$meanWatercontent))/sd(hem.both.long$meanWatercontent)
hem.both.long$DW<-(hem.both.long$DW-mean(hem.both.long$DW, na.rm=T))/sd(hem.both.long$DW, na.rm=T)




############## analysis data 2014, 2015

modelNall=glmer.nb(value ~percN.standard+meanSLA.standard+morphotype.x+percP.standard+vialID+(1+percN.standard|variable)+(1|site)+(1|vialID)+offset(DW),  data    =hem.both.long,glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000)))
null=glmer.nb(value~(1|variable)+(1|site)+offset(DW), data=hem.both.long)
modelPall=glmer.nb(value ~percN.standard+meanSLA.standard+morphotype.x+meanWatercontent.standard+percP.standard+(1+percP.standard|variable)+(1|site)+offset(DW),  data    =hem.both.long, glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000)))
modelSLAall=glmer.nb(value ~percN.standard+meanSLA.standard+morphotype.x+meanWatercontent.standard+percP.standard+(1+meanWatercontent.standard|variable)+(1|site)+offset(DW),  data    =hem.both.long, glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000)))
modelWaterall=glmer.nb(value ~percN.standard+meanSLA.standard+morphotype.x+meanWatercontent.standard+percP.standard+(1+meanSLA.standard|variable)+(1|site)+(1|variable)+offset(DW),  data    =hem.both.long,glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000)))
anova(null, modelNall,modelPall,modelSLAall,modelWaterall)



modelP=glmer(value ~morphotype.x +meanSLA.standard +percP.standard+(1+percP.standard|variable)+(1|site)+offset(DW),  data    =hem.both.long,   family    =poisson)
qqnorm(resid(modelP))
# overdispersed? negative binomial more appropriate

# best model is modelP, including morphotype, SLA and P, with species specific response to P and site also as random effect
modelP=glmer.nb(value ~meanSLA.standard+percP.standard+(1+percP.standard|variable)+(1|site)+offset(DW),  data    =hem.both.long)


modelNmorph=glmer.nb(value ~percN.standard+morphotype.x+(1+percN.standard|variable)+(1|site)+offset(DW),  data    =hem.both.long)
modelN=glmer.nb(value ~percN.standard+percP.standard+(1+percN.standard|variable)+(1|site)+offset(DW),  data    =hem.both.long)

modelPalone=glmer.nb(value ~percP.standard+(1+percP.standard|variable)+(1|site)+offset(DW),  data    =hem.both.long)
modelPmorph=glmer.nb(value ~morphotype.x+percP.standard+(1+percP.standard|variable)+(1|site)+offset(DW),  data    =hem.both.long)
modelPSLA=glmer.nb(value ~meanSLA.standard+(1+percP.standard|variable)+(1|site)+offset(DW),  data    =hem.both.long)


modelwP=glmer.nb(value ~morphotype.x+percP.standard+(1|variable)+(1|site)+offset(DW),  data    =hem.both.long)
morph=glmer.nb(value ~morphotype.x+(1|variable)+(1|site)+offset(DW),  data    =hem.both.long)

modelSLAmorph=glmer.nb(value ~morphotype.x+meanSLA.standard+(1+meanSLA.standard|variable)+(1|site)+offset(DW),  data    =hem.both.long)
modelW=glmer.nb(value ~meanSLA.standard+meanWatercontent.standard+morphotype.x+(1+meanSLA.standard|variable)+(1|site)+offset(DW),  data    =hem.both.long)
modelSLA=glmer.nb(value ~meanSLA.standard+percP.standard+(1+meanSLA.standard|variable)+(1|site)+offset(DW),  data    =hem.both.long)
modelWfull=glmer.nb(value ~meanSLA.standard+meanWatercontent.standard+morphotype.x+(1+meanWatercontent.standard|variable)+(1|site)+offset(DW),  data    =hem.both.long)
modelnone<-glmer.nb(value ~(1|variable)+(1|site)+offset(DW),  data    =hem.both.long)
modelmorph<-glmer.nb(value ~morphotype.x+(1|variable)+(1|site)+offset(DW),  data    =hem.both.long)


anova(modelP,modelPSLA,modelNmorphSLA,modelN, modelNmorph,modelPalone, modelPmorph,modelwP,morph, modelSLAmorph,modelW, modelSLA, modelWfull, modelnone, modelmorph)

# best model modelW ie SLA random effect
modelWN=glmer.nb(value ~meanSLA.standard+meanWatercontent.standard+morphotype.x+percN.standard+(1+meanSLA.standard|variable)+(1|site)+offset(DW),  data    =hem.both.long)
modelWPSLA=glmer.nb(value ~meanSLA.standard+meanWatercontent.standard+morphotype.x+percP.standard+(1+meanSLA.standard|variable)+(1|site)+offset(DW),  data    =hem.both.long)
modelWNP=glmer.nb(value ~meanSLA.standard+meanWatercontent.standard+morphotype.x+percN.standard+percP.standard+(1+meanSLA.standard|variable)+(1|site)+offset(DW),  data    =hem.both.long)

anova(modelW,modelWN,modelWPSLA,modelWNP,modelnone)
  
# modelWNP is best
mN=glmer.nb(value ~meanSLA.standard+meanWatercontent.standard+morphotype.x+percN+percP+(1+percN.standard|variable)+(1|site)+offset(DW),  data    =hem.both.long)  
mP=glmer.nb(value ~meanSLA.standard+meanWatercontent.standard+morphotype.x+percN.standard+percP.standard+(1+percP.standard|variable)+(1|site)+offset(DW),  data    =hem.both.long)   
mW=glmer.nb(value ~meanSLA.standard+meanWatercontent.standard+morphotype.x+percN.standard+percP.standard+(1+meanWatercontent.standard|variable)+(1|site)+offset(DW),  data    =hem.both.long)   
mMorph=glmer.nb(value ~meanSLA.standard+meanWatercontent.standard+morphotype.x+percN.standard+percP.standard+(1+morphotype.x|variable)+(1|site)+offset(DW),  data    =hem.both.long) 

anova(modelWNP,mN,mP,mW,mMorph)
# chisq p value =1 (???) but lowest AIC is modelWNP






# model with all leaf traits, and random effect of SLA is best model
summary(modelWNP)
dotplot(ranef(modelWNP, condVar=T))


pcsq<-sum(resid(modelWNP,type="pearson")^2)
rdf<-df.residual(modelWNP)
pchisq(pcsq,rdf,lower.tail=F)
pcsq/rdf











library(blmeco)
dispersion_glmer(modelWNP)
# alternatively could use package DHArma



################# Figures 2015 and 2014 data

cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7", "#000000", "green")
ggplot(data=hem.both.long, aes(x=meanSLA.standard, y=log(value), group=variable, colour=variable)) +
  #    geom_point()+
  geom_smooth(method=lm, se=F,level=0.95)+
  ylab("Abundance")+ xlab("standardized mean SLA")+
    theme_bw()


hemtop10<-hem.both.long[hem.both.long$variable==c("GRE_PSI"),]
hemtop10<-rbind(hemtop10,hem.both.long[hem.both.long$variable==c("OCE_VUL"),])
hemtop10<-rbind(hemtop10,hem.both.long[hem.both.long$variable==c("OPU_SP"),])
hemtop10<-rbind(hemtop10,hem.both.long[hem.both.long$variable==c("LEI_SP"),])
hemtop10<-rbind(hemtop10,hem.both.long[hem.both.long$variable==c("ORT_MET"),])
hemtop10<-rbind(hemtop10,hem.both.long[hem.both.long$variable==c("KOA_HAW"),])
hemtop10<-rbind(hemtop10,hem.both.long[hem.both.long$variable==c("SAR_ADO"),])
hemtop10<-rbind(hemtop10,hem.both.long[hem.both.long$variable==c("PAR_PYR"),])
hemtop10<-rbind(hemtop10,hem.both.long[hem.both.long$variable==c("TYM_TYM"),])
hemtop10<-rbind(hemtop10,hem.both.long[hem.both.long$variable==c("GEO_SP"),])


cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7", "#000000", "green", "#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7", "#000000", "green")
formatlines<-c(1,2,3,4,5,6,7,1,2,3,4,5,6,7,1,2,3,4,5,6)
spnames<-c("Greenidea psidii (Aphididae)", "Koanoa hawaiiensis (Miridae)", "Leialoha sp. (Delphacidae)", "Oceanides vulcans (Lygaeidae)",  "Opuna sp. (Miridae)", "Orthotylus metrosideri\n(Miridae)", "Pariaconus pyramidalis\n(Triozidae)", "Sarona adonias (Miridae)", "Tympanococcus tympanistus\n(Pseudococcidae)","Geometridae sp. (Lepidoptera)")

plotP<-ggplot(data=hemtop10, aes(x=percP.standard, y=log(value), group=variable, linetype=variable, colour=variable)) +
  geom_smooth(method=lm, se=F,level=0.95)+
  ylab("Abundance")+ xlab("standardized foliar phosphorus %")+
  scale_linetype_manual(values=formatlines, name="Species", labels=spnames)+
  scale_colour_manual(values=cbPalette, name="Species", labels=spnames)+
  theme_bw()

plotN<-ggplot(data=hemtop10, aes(x=percN.standard, y=log(value), group=variable, linetype=variable, colour=variable)) +
  geom_smooth(method=lm, se=F,level=0.95)+
  ylab("Abundance")+ xlab("standardized foliar nitrogen %")+
  scale_linetype_manual(values=formatlines, name="Species", labels=spnames, guide=F)+
  scale_colour_manual(values=cbPalette, name="Species", labels=spnames, guide=F)+
  theme_bw()

plotSLA<-ggplot(data=hemtop10, aes(x=meanSLA.standard, y=log(value), group=variable, linetype=variable, colour=variable)) +
  geom_smooth(method=lm, se=F,level=0.95)+
  ylab("Abundance")+ xlab("standardized mean specific leaf area (SLA)")+
  scale_linetype_manual(values=formatlines, name="Species", guide=F)+
  scale_colour_manual(values=cbPalette, name="Species", guide=F)+
  theme_bw()

ggplot(data=hemtop10, aes(x=morphotype.x, y=log(value), group=variable, linetype=variable, colour=variable)) +
  geom_point()+
  ylab("Abundance")+ xlab("standardized foliar phosphorus %")+
  scale_shape_manual(values=formatlines, name="Species", guide=F)+
  scale_colour_manual(values=cbPalette, name="Species", guide=F)+
  theme_bw()

plotwater<-ggplot(data=hemtop10, aes(x=meanWatercontent.standard, y=log(value), group=variable, linetype=variable, colour=variable)) +
  geom_smooth(method=lm, se=F,level=0.95)+
  ylab("Abundance")+ xlab("standardized mean water content")+
  scale_linetype_manual(values=formatlines, name="Species", guide=F)+
  scale_colour_manual(values=cbPalette, name="Species", guide=F)+
  theme_bw()

morph<-glmer.nb(hemtop10$value~hemtop10$morphotype.x+(1+morphotype.x|variable)+(1|site), data=hemtop10)
dotplot(ranef(morph, condVar=T))

par(mfrow=c(2,2))
plotN


grid.arrange(plotSLA,plotwater,plotN,plotP)
```











