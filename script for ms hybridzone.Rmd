---
title: "cleaned up Rmd for manuscript"
output: html_document
---

<br>
<br>

<br>


Objectives:


##### (i) How do herbivore communities respond to phenotypic variation?
##### (ii) Which plant traits account for herbivore community responses to host-plant phenotype?
##### (iii) Which insect traits account for herbivore community responses to host-plant phenotype








Contents:
- Summary stats
- species richness across plant traits
- abundance across plant traits
- figure abundance & richness across morphotype
- nmds figure
- permanova
- cca? can you find how much variance explained with permanova?
- glmer figures
- glmer model output
- traitglm/fourth corner figure
- fourth corner output
- supplemental materials


<br>
<br>


```{r Load_data&packages, echo=FALSE, warning=FALSE, message=FALSE}
rm(list=ls())


library(ggplot2)
library(scales)
library(lattice)
library(vegan)
library(iNEXT)
library(plyr)
library(mvabund)
library(reshape2)
library(lme4)
library(gridExtra)
library(lmerTest)

#try species by site dataset, including leps and coleoptera
setwd("/Users/elsketielens/phd/data/HDIM/branch clipping/data/data for R")
hem<-read.table("hem.sep18.csv", header=TRUE, sep="")

##load other datasets 
setwd("/Users/elsketielens/phd/data/HDIM/branch clipping/data/data for R")
env<- read.table("env site july16.csv", header=TRUE, sep=",")
env<-env[env$vialID%in%rownames(hem),]
setwd("/Users/elsketielens/phd/data/HDIM/branch clipping/data/data for R")
traits<-read.table("trait species july16new.csv", header=T, sep=",")
setwd("/Users/elsketielens/phd/data/HDIM/branch clipping/data/data for R")
leaftraits.full<-read.table("leaf traits july16.csv", header=TRUE, sep=",")


# Subset to only four sites, for both years
env.both<-env[env$site!="ERY",]
env.both<-env.both[env.both$site!=c("TPR"),]
env.both<-env.both[env.both$site!=c("KAIO"),]
env.both<-env.both[env.both$site!=c("THU"),]
env.both<-env.both[env.both$site!=c("LH"),]
env.both<-env.both[env.both$site!=c("LY"),]
env.both<-env.both[env.both$site!=c("L65"),]
env.both<-env.both[env.both$site!=c("KOHY"),]
env.both<-env.both[env.both$site!=c("KOHO"),]
env.both<-env.both[env.both$island=="Hawaii",]

# create env data for 2014
env.2014<-env.both[env.both$sampleyear=="2014",]


# create hem data
hem.both<-hem[rownames(hem)%in%env.both$vialID,]
hem.2014<-hem[rownames(hem)%in%env.2014$vialID,]

## Create traits data 
#traits.both<-traits[rownames(traits)%in%colnames(hem.both),]
traits<-traits[traits$spec_code%in%colnames(hem.2014),]

# exclude species that don't occur in our four sites
hem.both<-hem.both[,colSums(hem.both)>0]
hem.2014<-hem.2014[,colSums(hem.2014)>0]

# remove predators
traits<- traits[traits$spec_code!="NAB_OSC",]
traits<- traits[traits$spec_code!="COC_SP",]
traits<- traits[traits$spec_code!="PHI_SPU",]
#traits.both<-traits[traits$spec_code%in%colnames(hem.both),]    ### only need to do this for 2014 data? because used for fourth corner mostly?

# exclude species for which we don't have trait data. 
hem.both<-hem.both[ ,which( colnames(hem.both) %in% traits$spec_code )]
hem.2014<-hem.2014[ ,which( colnames(hem.2014) %in% traits$spec_code )]

traits<-traits[traits$spec_code%in%colnames(hem.2014),]
rownames(traits)<-traits$spec_code
traits<-traits[,-c(1)]

## There are NA's in the dataset. Remove.
leaftraits.full<-na.omit(leaftraits.full)

#select subset traits to prevent collinearity
leaftraits.full<-merge(leaftraits.full, env[,c(1,10)], by="vialID")
rownames(leaftraits.full)<-leaftraits.full$vialID
leaftraits.full<-leaftraits.full[,c(3,4,6,7,10,11)]
colnames(leaftraits.full)<-c("percN", "percP", "meanSLA", "meanWatercontent", "CN", "morphotype")

## Create leaftraits data (2014 only)
leaftraits<-leaftraits.full[rownames(leaftraits.full)%in%env.2014$vialID,]


env$morphotype<-factor(env$morphotype, levels=c("G", "H", "P"))

# set different level of morphotype as intercept
leaftraits$morphotype<-factor(leaftraits$morphotype, levels=c("H", "G", "P"))

# load gps coordinates
setwd("/Users/elsketielens/phd/data/HDIM/branch clipping/data/data for R")
xy<-read.table("coordinatesHDIM.csv", header=TRUE, sep=",")
xy<-xy[xy$vialID%in%env$vialID,]
xy.2014<-xy[xy$vialID %in% env.2014$vialID,]
xy.both<-xy[xy$vialID %in% env.both$vialID,]
```
<br>

```{r scale}


leaftraits$percN<- scale(leaftraits$percN,center=T,scale=T)
leaftraits$percP<- scale(leaftraits$percP,center=T,scale=T)
leaftraits$meanSLA<- scale(leaftraits$meanSLA,center=T,scale=T)
leaftraits$meanWatercontent<- scale(leaftraits$meanWatercontent,center=T,scale=T)
leaftraits$CN<- scale(leaftraits$CN,center=T,scale=T)

leaftraits.full$percN<- scale(leaftraits.full$percN,center=T,scale=T)
leaftraits.full$percP<- scale(leaftraits.full$percP,center=T,scale=T)
leaftraits.full$meanSLA<- scale(leaftraits.full$meanSLA,center=T,scale=T)
leaftraits.full$meanWatercontent<- scale(leaftraits.full$meanWatercontent,center=T,scale=T)
leaftraits.full$CN<- scale(leaftraits.full$CN,center=T,scale=T)

env.2014$DW<-offset(scale(env.2014$DW, scale=T, center=T))
env.both$DW<-offset(scale(env.both$DW, scale=T, center=T))
```



## Results




#### Summary stats




```{r summary}

# number of trees sampled 2014
nrow(hem.2014)
# number of tree sampled for both years
nrow(hem.both)
# total number of individuals
sum(rowSums(hem.both))
# number of taxa
ncol(hem.both)

# trees per morphotype
# glabrous:
nrow(hem.both[env.both$morphotype=="G",])
# pubescent 
nrow(hem.both[env.both$morphotype=="P",])
# hybrid
nrow(hem.both[env.both$morphotype=="H",])

# sampling effort:

# mean and sd overall sampling effort
mean(env.2014$DW)
sd(env.2014$DW)

# mean and sd sampling effort per morphotype:
ddply(env.2014, .(morphotype),summarize, mean=mean(DW), sd=sd(DW))

# do sampling efforts differ between morphotypes?
summary(lm(env.2014$DW~env.2014$morphotype))

#do sampling efforts differ between sites?
ddply(env.2014, .(site),summarize, mean=mean(DW), sd=sd(DW))

summary(lm(env.2014$DW~env.2014$site))
```
<br>


<br>

<br>

#### NMDS figure

<br>

```{r}
hem.ero<-hem[env$site=="ERO",]
hem.ali<-hem[env$site=="ALI",]
hem.kaiy<-hem[env$site=="KAIY",]
hem.olaa<-hem[env$site=="OLAA",]
hem.kaio<-hem[env$site=="KAIO",]

hem.kai.all<-rbind(hem.kaiy,hem.kaio)
env.kai.all<-rbind(env[env$site=="KAIY",],env[env$site=="KAIO",])



## figure output for draft:

  par(mfrow=c(1,2))

moment<-metaMDS(hem.kai.all, k=3)
mds.fig <- ordiplot(moment, type = "none", main="Kaiholena (n=17)")
points(mds.fig, "sites", pch = 15, cex=1.5,col = "blue", select = env.kai.all$morphotype == "H")
points(mds.fig, "sites", pch = 19, cex=1.5,col = "red", select = env.kai.all$morphotype == "P")
points(mds.fig, "sites", pch = 17, cex=1.5,col = "green", select = env.kai.all$morphotype == "G")
Lab<-c( "Glabrous","Hybrid", "Pubescent")
legend(  "topright", legend=Lab,pch=c(17,15,19),col=c("green","blue", "red", "green"),pt.cex=1.5,cex=0.9,xpd=TRUE)

moment<-metaMDS(hem.olaa, k=3)
mds.fig <- ordiplot(moment, type = "none", main="HAVO Olaa")
points(mds.fig, "sites", pch = 17,cex=1.5, col = "green", select = env[env$site=="OLAA",]$morphotype == "G")
points(mds.fig, "sites", pch = 15,cex=1.5, col = "blue", select = env[env$site=="OLAA",]$morphotype == "H")
Lab<-c("Glabrous","Hybrid", "Pubescent")
color<-c("green","blue", "red","green" )
legend(  "topright", legend=Lab,pch=c(17,15,19),col=c(color),pt.cex=1.5,cex=0.9,xpd=TRUE)







adonis(hem.ali~env[env$site=="ALI",]$morphotype, by="margin")
adonis(hem.kai.all~env.kai.all$morphotype, by="margin")
#adonis(hem.kaiy~env[env$site=="KAIY",]$morphotype, by="margin")
adonis(hem.ero~env[env$site=="ERO",]$morphotype, by="margin")
adonis(hem.olaa~env[env$site=="OLAA",]$morphotype, by="margin")




```

<br>




<br>




#### Figures of richness and abundance per morphotype


```{r}
par(mfrow=c(1,2))


plot(rowSums(hem.both)~factor(env.both$morphotype),  ylab="Abundance", xlab="tree morphotype" )
plot(exp(ChaoShannon(as.data.frame(t(hem.both)), datatype = "abundance")[,2])~factor(env.both$morphotype),  ylab="Exp Estimated Shannon (hill 1)", xlab="tree morphotype" )


#summary(lm(specnumber(trial)~factor(env.trial$morphotype)))
summary(lm(exp(ChaoShannon(as.data.frame(t(hem.both)), datatype = "abundance")[,2])~factor(env.both$morphotype)))
summary(lm(rowSums(hem.both)~factor(env.both$morphotype)))
summary(lm(rowSums(hem.2014)~leaftraits$percP))


par(mfrow=c(1,1))
plot(exp(ChaoShannon(as.data.frame(t(hem.both)), datatype = "abundance")[,2])~env.both$DW,  ylab="exp shannon index (hill 1)", xlab="sampling effort (DW in g)")

plot(rowSums(hem.2014)~leaftraits$percP,  ylab="Insect Abundance", xlab="Foliar Phosphorus Content (%)", pch=16)
```









- glmer figures
- glmer model output
- traitglm/fourth corner figure
- fourth corner output
- supplemental materials










#### (ii) Which plant traits account for herbivore community responses to host-plant phenotype?



<br>

```{r Cor}
# partition variance between environment and spatial

test<-varpart(vegdist(decostand(hem.2014, "hel"), method="bray"), leaftraits[,c(1,2,3,4,6)], xy.2014[,2:3])
test
plot(test)

p<-dbrda(vegdist(decostand(hem.2014, "hel"), method="bray")~leaftraits[,1]+ xy.2014[,2]+xy.2014[,3] + leaftraits[,2] +leaftraits[,3]+leaftraits[,4]+leaftraits[,6] )
p
anova(p)


adonis(hem.2014~env.2014$morphotype+leaftraits$percN+leaftraits$meanWatercontent+leaftraits$meanSLA+leaftraits$percP, by="margin")





```

<br>

#########################################################################################################
#####################                                                               #####################
#####################              Model selection portion                          #####################                         
#####################                                                               #####################
#########################################################################################################
<br>

#### (iii) What plant traits drive diversity and abundance across these four sites?

<br>
##### single predictor models

```{r}
shan<-exp(ChaoShannon(as.data.frame(t(hem.2014)) )[,2])
simps<-1-ChaoSimpson(as.data.frame(t(hem.2014), na.rm=TRUE) )[,2]
tem<-ChaoRichness(as.data.frame(t(hem.2014)))[,2]



anova(lmer(shan~env.2014$morphotype+(1|env.2014$site)+offset(env.2014$DW)))
anova(lmer(shan~leaftraits$percN+(1|env.2014$site)+offset(env.2014$DW)))
# sig nitrogen, F=5.3329, p=0.04213
anova(lmer(shan~leaftraits$percP+(1|env.2014$site)+offset(env.2014$DW)))
anova(lmer(shan~leaftraits$meanSLA+(1|env.2014$site)+offset(env.2014$DW)))
anova(lmer(shan~leaftraits$meanWatercontent+(1|env.2014$site)+offset(env.2014$DW)))


anova(lmer(simps~env.2014$morphotype+(1|env.2014$site)+offset(env.2014$DW)))
anova(lmer(simps~leaftraits$percN+(1|env.2014$site)+offset(env.2014$DW)))
# sig nitrogen F=11.548, p=0.00885
anova(lmer(simps~leaftraits$percP+(1|env.2014$site)+offset(env.2014$DW)))
anova(lmer(simps~leaftraits$meanSLA+(1|env.2014$site)+offset(env.2014$DW)))
anova(lmer(simps~leaftraits$meanWatercontent+(1|env.2014$site)+offset(env.2014$DW)))

anova(lmer(tem~env.2014$morphotype+(1|env.2014$site)+offset(env.2014$DW)))
anova(lmer(tem~leaftraits$percN+(1|env.2014$site)+offset(env.2014$DW)))
anova(lmer(tem~leaftraits$percP+(1|env.2014$site)+offset(env.2014$DW)))
anova(lmer(tem~leaftraits$meanSLA+(1|env.2014$site)+offset(env.2014$DW)))
anova(lmer(tem~leaftraits$meanWatercontent+(1|env.2014$site)+offset(env.2014$DW)))

anova(lmer(rowSums(hem.2014)~env.2014$morphotype+(1|env.2014$site)+offset(env.2014$DW)))
anova(lmer(rowSums(hem.2014)~leaftraits$percN+(1|env.2014$site)+offset(env.2014$DW)))
anova(lmer(rowSums(hem.2014)~leaftraits$percP+(1|env.2014$site)+offset(env.2014$DW)))
## sig phosphorus F=6.2651, p=0.03169
anova(lmer(rowSums(hem.2014)~leaftraits$meanSLA+(1|env.2014$site)+offset(env.2014$DW)))
anova(lmer(rowSums(hem.2014)~leaftraits$meanWatercontent+(1|env.2014$site)+offset(env.2014$DW)))
```



```{r}



shan<-exp(ChaoShannon(as.data.frame(t(hem.2014)) )[,2])
anova(lm(shan~env.2014$morphotype))
mod1<-lmer(shan~env.2014$morphotype+leaftraits$percN+leaftraits$percP+leaftraits$meanSLA+leaftraits$meanWatercontent+(1|env.2014$site)+offset(env.2014$DW))
mod2<-lmer(shan~leaftraits$percN+leaftraits$percP+leaftraits$meanSLA+leaftraits$meanWatercontent+(1|env.2014$site)+offset(env.2014$DW))
mod3<-lmer(shan~env.2014$morphotype+leaftraits$percP+leaftraits$meanSLA+leaftraits$meanWatercontent+(1|env.2014$site)+offset(env.2014$DW))
mod4<-lmer(shan~env.2014$morphotype+leaftraits$percN+leaftraits$meanSLA+leaftraits$meanWatercontent+(1|env.2014$site)+offset(env.2014$DW))
mod5<-lmer(shan~env.2014$morphotype+leaftraits$percN+leaftraits$percP+leaftraits$meanWatercontent+(1|env.2014$site)+offset(env.2014$DW))
mod6<-lmer(shan~env.2014$morphotype+leaftraits$percN+leaftraits$percP+leaftraits$meanSLA+(1|env.2014$site)+offset(env.2014$DW))

anova(mod1,mod2,mod3,mod4,mod5,mod6)

mod7<-lmer(shan~leaftraits$percP+leaftraits$meanSLA+leaftraits$meanWatercontent+(1|env.2014$site)+offset(env.2014$DW))
mod8<-lmer(shan~leaftraits$percN+leaftraits$meanSLA+leaftraits$meanWatercontent+(1|env.2014$site)+offset(env.2014$DW))
mod9<-lmer(shan~leaftraits$percN+leaftraits$percP+leaftraits$meanWatercontent+(1|env.2014$site)+offset(env.2014$DW))
mod10<-lmer(shan~leaftraits$percN+leaftraits$percP+leaftraits$meanSLA+(1|env.2014$site)+offset(env.2014$DW))
anova(mod2,mod7,mod8,mod9,mod10)

mod11<-lmer(shan~leaftraits$meanSLA+leaftraits$meanWatercontent+(1|env.2014$site)+offset(env.2014$DW))
mod12<-lmer(shan~leaftraits$percN+leaftraits$meanWatercontent+(1|env.2014$site)+offset(env.2014$DW))
mod13<-lmer(shan~leaftraits$percN+leaftraits$meanSLA+(1|env.2014$site)+offset(env.2014$DW))
anova(mod2,mod8,mod11,mod12,mod13)

mod14<-lmer(shan~(1|env.2014$site)+offset(env.2014$DW))
mod15<-lmer(shan~leaftraits$meanSLA+(1|env.2014$site)+offset(env.2014$DW))
mod16<-lmer(shan~leaftraits$percN+(1|env.2014$site)+offset(env.2014$DW))
anova(mod14,mod15,mod16,mod13,mod2,mod8)

# mod13 is best in explaining exp shannon; ie model with percN, meanSLA and site as random effect
anova(mod14,mod13)
summary(mod13)





simps<-1-ChaoSimpson(as.data.frame(t(hem.2014), na.rm=TRUE) )[,2]

m1<-lmer(simps~env.2014$morphotype+leaftraits$percN+leaftraits$percP+leaftraits$meanSLA+leaftraits$meanWatercontent+(1|env.2014$site)+offset(env.2014$DW))
m2<-lmer(simps~(1|env.2014$site)+offset(env.2014$DW))
anova(m1,m2)

m3<-lmer(simps~leaftraits$percN+leaftraits$percP+leaftraits$meanSLA+leaftraits$meanWatercontent+(1|env.2014$site)+offset(env.2014$DW))
m4<-lmer(simps~env.2014$morphotype+leaftraits$percP+leaftraits$meanSLA+leaftraits$meanWatercontent+(1|env.2014$site)+offset(env.2014$DW))
m5<-lmer(simps~env.2014$morphotype+leaftraits$percN+leaftraits$meanSLA+leaftraits$meanWatercontent+(1|env.2014$site)+offset(env.2014$DW))
m6<-lmer(simps~env.2014$morphotype+leaftraits$percN+leaftraits$percP+leaftraits$meanWatercontent+(1|env.2014$site)+offset(env.2014$DW))
m7<-lmer(simps~env.2014$morphotype+leaftraits$percN+leaftraits$percP+leaftraits$meanSLA+(1|env.2014$site)+offset(env.2014$DW))
anova(m1,m2,m3,m4,m5,m6,m7)

m8<-lmer(simps~leaftraits$percP+leaftraits$meanSLA+leaftraits$meanWatercontent+(1|env.2014$site)+offset(env.2014$DW))
m9<-lmer(simps~leaftraits$percN+leaftraits$meanSLA+leaftraits$meanWatercontent+(1|env.2014$site)+offset(env.2014$DW))
m10<-lmer(simps~leaftraits$percN+leaftraits$percP+leaftraits$meanWatercontent+(1|env.2014$site)+offset(env.2014$DW))
m11<-lmer(simps~leaftraits$percN+leaftraits$percP+leaftraits$meanSLA+(1|env.2014$site)+offset(env.2014$DW))
anova(m2,m3,m8,m9,m10,m11)

m12<-lmer(simps~leaftraits$percP+leaftraits$meanSLA+(1|env.2014$site)+offset(env.2014$DW))
m13<-lmer(simps~leaftraits$percN+leaftraits$meanSLA+(1|env.2014$site)+offset(env.2014$DW))
m14<-lmer(simps~leaftraits$percN+leaftraits$percP+(1|env.2014$site)+offset(env.2014$DW))
anova(m2,m3,m10,m11,m12,m13,m14)

m15<-lmer(simps~leaftraits$meanSLA+(1|env.2014$site)+offset(env.2014$DW))
m16<-lmer(simps~leaftraits$percN+(1|env.2014$site)+offset(env.2014$DW))
anova(m2,m13,m15,m16,m10)


#best model is m10, lowest AIC, low df
summary(m10)
anova(m2,m10)


# estimated richness
tem<-ChaoRichness(as.data.frame(t(hem.2014)))[,2]

rich1<-lmer(tem~env.2014$morphotype+leaftraits$percN+leaftraits$percP+leaftraits$meanSLA+leaftraits$meanWatercontent+(1|env.2014$site)+offset(env.2014$DW))
rich2<-lmer(tem~(1|env.2014$site)+offset(env.2014$DW))
anova(rich1,rich2)

rich3<-lmer(tem~leaftraits$percN+leaftraits$percP+leaftraits$meanSLA+leaftraits$meanWatercontent+(1|env.2014$site)+offset(env.2014$DW))
rich4<-lmer(tem~env.2014$morphotype+leaftraits$percP+leaftraits$meanSLA+leaftraits$meanWatercontent+(1|env.2014$site)+offset(env.2014$DW))
rich5<-lmer(tem~env.2014$morphotype+leaftraits$percN+leaftraits$meanSLA+leaftraits$meanWatercontent+(1|env.2014$site)+offset(env.2014$DW))
rich6<-lmer(tem~env.2014$morphotype+leaftraits$percN+leaftraits$percP+leaftraits$meanWatercontent+(1|env.2014$site)+offset(env.2014$DW))
rich7<-lmer(tem~env.2014$morphotype+leaftraits$percN+leaftraits$percP+leaftraits$meanSLA+(1|env.2014$site)+offset(env.2014$DW))
anova(rich1,rich2,rich3,rich4,rich5,rich6,rich7)

rich8<-lmer(tem~leaftraits$percN+leaftraits$percP+leaftraits$meanWatercontent+(1|env.2014$site)+offset(env.2014$DW))
rich9<-lmer(tem~env.2014$morphotype+leaftraits$percP+leaftraits$meanWatercontent+(1|env.2014$site)+offset(env.2014$DW))
rich10<-lmer(tem~env.2014$morphotype+leaftraits$percN+leaftraits$meanWatercontent+(1|env.2014$site)+offset(env.2014$DW))
rich11<-lmer(tem~env.2014$morphotype+leaftraits$percN+leaftraits$percP+(1|env.2014$site)+offset(env.2014$DW))
anova(rich2,rich6,rich8,rich9,rich10,rich11)

rich12<-lmer(tem~leaftraits$percP+leaftraits$meanWatercontent+(1|env.2014$site)+offset(env.2014$DW))
rich13<-lmer(tem~leaftraits$percN+leaftraits$meanWatercontent+(1|env.2014$site)+offset(env.2014$DW))
rich14<-lmer(tem~leaftraits$percN+leaftraits$percP+(1|env.2014$site)+offset(env.2014$DW))
anova(rich2,rich8,rich12,rich13,rich14,rich6)

rich15<-lmer(tem~leaftraits$percP+(1|env.2014$site)+offset(env.2014$DW))
rich16<-lmer(tem~leaftraits$percN+(1|env.2014$site)+offset(env.2014$DW))
anova(rich2,rich15,rich16,rich14)

#rich14 is best, with N and P
summary(rich14)
anova(rich2,rich14)


# richness does diff sig between morphotype, diversity shannon or simpson does not.
# ie the difference between glabrous and hybrid and glabrous and pubescent is in rare species- glabrous has more rare species than the other two morphotypes, but once you weigh rare species less, there are no differences in diversity


abun1<-lmer(rowSums(hem.2014)~env.2014$morphotype+leaftraits$percN+leaftraits$percP+leaftraits$meanSLA+leaftraits$meanWatercontent+(1|env.2014$site)+offset(env.2014$DW))
abun2<-lmer(rowSums(hem.2014)~(1|env.2014$site)+offset(env.2014$DW))
anova(abun1,abun2)

abun3<-lmer(rowSums(hem.2014)~leaftraits$percN+leaftraits$percP+leaftraits$meanSLA+leaftraits$meanWatercontent+(1|env.2014$site)+offset(env.2014$DW))
abun4<-lmer(rowSums(hem.2014)~env.2014$morphotype+leaftraits$percP+leaftraits$meanSLA+leaftraits$meanWatercontent+(1|env.2014$site)+offset(env.2014$DW))
abun7<-lmer(rowSums(hem.2014)~env.2014$morphotype+leaftraits$percN+leaftraits$meanSLA+leaftraits$meanWatercontent+(1|env.2014$site)+offset(env.2014$DW))
abun5<-lmer(rowSums(hem.2014)~env.2014$morphotype+leaftraits$percN+leaftraits$percP+leaftraits$meanWatercontent+(1|env.2014$site)+offset(env.2014$DW))
abun6<-lmer(rowSums(hem.2014)~env.2014$morphotype+leaftraits$percN+leaftraits$percP+leaftraits$meanSLA+(1|env.2014$site)+offset(env.2014$DW))
anova(abun1,abun2,abun3,abun4,abun5,abun6,abun7)

abun8<-lmer(rowSums(hem.2014)~leaftraits$percP+leaftraits$meanSLA+leaftraits$meanWatercontent+(1|env.2014$site)+offset(env.2014$DW))
abun9<-lmer(rowSums(hem.2014)~env.2014$morphotype+leaftraits$meanSLA+leaftraits$meanWatercontent+(1|env.2014$site)+offset(env.2014$DW))
abun10<-lmer(rowSums(hem.2014)~env.2014$morphotype+leaftraits$percP+leaftraits$meanWatercontent+(1|env.2014$site)+offset(env.2014$DW))
abun11<-lmer(rowSums(hem.2014)~env.2014$morphotype+leaftraits$percP+leaftraits$meanSLA+(1|env.2014$site)+offset(env.2014$DW))
anova(abun1,abun2,abun4,abun5,abun8,abun9,abun10,abun11)

abun12<-lmer(rowSums(hem.2014)~leaftraits$percP+leaftraits$meanWatercontent+(1|env.2014$site)+offset(env.2014$DW))
abun13<-lmer(rowSums(hem.2014)~env.2014$morphotype+leaftraits$meanWatercontent+(1|env.2014$site)+offset(env.2014$DW))
abun14<-lmer(rowSums(hem.2014)~env.2014$morphotype+leaftraits$percP+(1|env.2014$site)+offset(env.2014$DW))
anova(abun2,abun10,abun12,abun13,abun14)

abun15<-lmer(rowSums(hem.2014)~leaftraits$meanWatercontent+(1|env.2014$site)+offset(env.2014$DW))
abun16<-lmer(rowSums(hem.2014)~leaftraits$percP+(1|env.2014$site)+offset(env.2014$DW))

anova(abun2,abun12,abun15,abun16)
#model abun12 is best, with water, phosphorus and site as random
anova(abun2,abun12)
summary(abun12)


```

<br>


<br>



#### GLMER model selection

```{r}
# dataset with 2014 and 2015 data
hem.both$vialID<-rownames(hem.both)
hem.both.long<-melt(hem.both)
hem.both.long<-merge(env.both, hem.both.long, by="vialID")
leaftraits$vialID<-rownames(leaftraits)
temp<-merge(leaftraits,env[,c(1:3)], by="vialID")
temp<-temp[,-1]   
hem.both.long<-hem.both.long[,-1]

hem.both.long<-merge(hem.both.long, temp, by=c("site", "plot"))

hem.both.long$percN.standard<-(hem.both.long$percN-mean(hem.both.long$percN))/sd(hem.both.long$percN)
hem.both.long$percP.standard<-(hem.both.long$percP-mean(hem.both.long$percP))/sd(hem.both.long$percP)
hem.both.long$meanSLA.standard<-(hem.both.long$meanSLA-mean(hem.both.long$meanSLA))/sd(hem.both.long$meanSLA)
hem.both.long$meanWatercontent.standard<-(hem.both.long$meanWatercontent-mean(hem.both.long$meanWatercontent))/sd(hem.both.long$meanWatercontent)


############## analysis data 2014, 2015

modelP=glmer(value ~morphotype.x +meanSLA.standard +percP.standard+(1+percP.standard|variable)+(1|site)+offset(DW),  data    =hem.both.long,   family    =poisson)
qqnorm(resid(modelP))
# overdispersed? negative binomial more appropriate

# best model is modelP, including morphotype, SLA and P, with species specific response to P and site also as random effect
modelP=glmer.nb(value ~meanSLA.standard+percP.standard+(1+percP.standard|variable)+(1|site)+offset(DW),  data    =hem.both.long)



modelNmorphSLA=glmer.nb(value ~percN.standard+meanSLA.standard+morphotype.x+(1+percN.standard|variable)+(1|site)+offset(DW),  data    =hem.both.long)
modelNmorph=glmer.nb(value ~percN.standard+morphotype.x+(1+percN.standard|variable)+(1|site)+offset(DW),  data    =hem.both.long)
modelN=glmer.nb(value ~percN.standard+percP.standard+(1+percN.standard|variable)+(1|site)+offset(DW),  data    =hem.both.long)

modelPalone=glmer.nb(value ~percP.standard+(1+percP.standard|variable)+(1|site)+offset(DW),  data    =hem.both.long)
modelPmorph=glmer.nb(value ~morphotype.x+percP.standard+(1+percP.standard|variable)+(1|site)+offset(DW),  data    =hem.both.long)
modelPSLA=glmer.nb(value ~meanSLA.standard+(1+percP.standard|variable)+(1|site)+offset(DW),  data    =hem.both.long)


modelwP=glmer.nb(value ~morphotype.x+percP.standard+(1|variable)+(1|site)+offset(DW),  data    =hem.both.long)
morph=glmer.nb(value ~morphotype.x+(1|variable)+(1|site)+offset(DW),  data    =hem.both.long)

modelSLAmorph=glmer.nb(value ~morphotype.x+meanSLA.standard+(1+meanSLA.standard|variable)+(1|site)+offset(DW),  data    =hem.both.long)
modelW=glmer.nb(value ~meanSLA.standard+meanWatercontent.standard+morphotype.x+(1+meanSLA.standard|variable)+(1|site)+offset(DW),  data    =hem.both.long)
modelSLA=glmer.nb(value ~meanSLA.standard+percP.standard+(1+meanSLA.standard|variable)+(1|site)+offset(DW),  data    =hem.both.long)
modelWfull=glmer.nb(value ~meanSLA.standard+meanWatercontent.standard+morphotype.x+(1+meanWatercontent.standard|variable)+(1|site)+offset(DW),  data    =hem.both.long)
modelnone<-glmer.nb(value ~(1|variable)+(1|site)+offset(DW),  data    =hem.both.long)
modelmorph<-glmer.nb(value ~morphotype.x+(1|variable)+(1|site)+offset(DW),  data    =hem.both.long)


anova(modelP,modelPSLA,modelNmorphSLA,modelN, modelNmorph,modelPalone, modelPmorph,modelwP,morph, modelSLAmorph,modelW, modelSLA, modelWfull, modelnone, modelmorph)

# best model modelW ie SLA random effect
modelWN=glmer.nb(value ~meanSLA.standard+meanWatercontent.standard+morphotype.x+percN.standard+(1+meanSLA.standard|variable)+(1|site)+offset(DW),  data    =hem.both.long)
modelWPSLA=glmer.nb(value ~meanSLA.standard+meanWatercontent.standard+morphotype.x+percP.standard+(1+meanSLA.standard|variable)+(1|site)+offset(DW),  data    =hem.both.long)
modelWNP=glmer.nb(value ~meanSLA.standard+meanWatercontent.standard+morphotype.x+percN.standard+percP.standard+(1+meanSLA.standard|variable)+(1|site)+offset(DW),  data    =hem.both.long)

anova(modelW,modelWN,modelWPSLA,modelWNP,modelnone)
  
# modelWNP is best
mN=glmer.nb(value ~meanSLA.standard+meanWatercontent.standard+morphotype.x+percN+percP+(1+percN.standard|variable)+(1|site)+offset(DW),  data    =hem.both.long)  
mP=glmer.nb(value ~meanSLA.standard+meanWatercontent.standard+morphotype.x+percN.standard+percP.standard+(1+percP.standard|variable)+(1|site)+offset(DW),  data    =hem.both.long)   
mW=glmer.nb(value ~meanSLA.standard+meanWatercontent.standard+morphotype.x+percN.standard+percP.standard+(1+meanWatercontent.standard|variable)+(1|site)+offset(DW),  data    =hem.both.long)   
mMorph=glmer.nb(value ~meanSLA.standard+meanWatercontent.standard+morphotype.x+percN.standard+percP.standard+(1+morphotype.x|variable)+(1|site)+offset(DW),  data    =hem.both.long) 

anova(modelWNP,mN,mP,mW,mMorph)
# chisq p value =1 (???) but lowest AIC is modelWNP






# model with all leaf traits, and random effect of SLA is best model
summary(modelWNP)
dotplot(ranef(modelWNP, condVar=T))


pcsq<-sum(resid(modelWNP,type="pearson")^2)
rdf<-df.residual(modelWNP)
pchisq(pcsq,rdf,lower.tail=F)
pcsq/rdf











library(blmeco)
dispersion_glmer(modelWNP)
# alternatively could use package DHArma



################# Figures 2015 and 2014 data

cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7", "#000000", "green")
ggplot(data=hem.both.long, aes(x=meanSLA.standard, y=log(value), group=variable, colour=variable)) +
  #    geom_point()+
  geom_smooth(method=lm, se=F,level=0.95)+
  ylab("Abundance")+ xlab("standardized mean SLA")+
    theme_bw()


hemtop10<-hem.both.long[hem.both.long$variable==c("GRE_PSI"),]
hemtop10<-rbind(hemtop10,hem.both.long[hem.both.long$variable==c("OCE_VUL"),])
hemtop10<-rbind(hemtop10,hem.both.long[hem.both.long$variable==c("OPU_SP"),])
hemtop10<-rbind(hemtop10,hem.both.long[hem.both.long$variable==c("LEI_SP"),])
hemtop10<-rbind(hemtop10,hem.both.long[hem.both.long$variable==c("ORT_MET"),])
hemtop10<-rbind(hemtop10,hem.both.long[hem.both.long$variable==c("KOA_HAW"),])
hemtop10<-rbind(hemtop10,hem.both.long[hem.both.long$variable==c("SAR_ADO"),])
hemtop10<-rbind(hemtop10,hem.both.long[hem.both.long$variable==c("PAR_PYR"),])
hemtop10<-rbind(hemtop10,hem.both.long[hem.both.long$variable==c("TYM_TYM"),])
hemtop10<-rbind(hemtop10,hem.both.long[hem.both.long$variable==c("GEO_SP"),])


cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7", "#000000", "green", "#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7", "#000000", "green")
formatlines<-c(1,2,3,4,5,6,7,1,2,3,4,5,6,7,1,2,3,4,5,6)
spnames<-c("Greenidea psidii (Aphididae)", "Koanoa hawaiiensis (Miridae)", "Leialoha sp. (Delphacidae)", "Oceanides vulcans (Lygaeidae)",  "Opuna sp. (Miridae)", "Orthotylus metrosideri\n(Miridae)", "Pariaconus pyramidalis\n(Triozidae)", "Sarona adonias (Miridae)", "Tympanococcus tympanistus\n(Pseudococcidae)","Geometridae sp. (Lepidoptera)")

plotP<-ggplot(data=hemtop10, aes(x=percP.standard, y=log(value), group=variable, linetype=variable, colour=variable)) +
  geom_smooth(method=lm, se=F,level=0.95)+
  ylab("Abundance")+ xlab("standardized foliar phosphorus %")+
  scale_linetype_manual(values=formatlines, name="Species", labels=spnames)+
  scale_colour_manual(values=cbPalette, name="Species", labels=spnames)+
  theme_bw()

plotN<-ggplot(data=hemtop10, aes(x=percN.standard, y=log(value), group=variable, linetype=variable, colour=variable)) +
  geom_smooth(method=lm, se=F,level=0.95)+
  ylab("Abundance")+ xlab("standardized foliar nitrogen %")+
  scale_linetype_manual(values=formatlines, name="Species", labels=spnames, guide=F)+
  scale_colour_manual(values=cbPalette, name="Species", labels=spnames, guide=F)+
  theme_bw()

plotSLA<-ggplot(data=hemtop10, aes(x=meanSLA.standard, y=log(value), group=variable, linetype=variable, colour=variable)) +
  geom_smooth(method=lm, se=F,level=0.95)+
  ylab("Abundance")+ xlab("standardized mean specific leaf area (SLA)")+
  scale_linetype_manual(values=formatlines, name="Species", guide=F)+
  scale_colour_manual(values=cbPalette, name="Species", guide=F)+
  theme_bw()

ggplot(data=hemtop10, aes(x=morphotype.x, y=log(value), group=variable, linetype=variable, colour=variable)) +
  geom_point()+
  ylab("Abundance")+ xlab("standardized foliar phosphorus %")+
  scale_shape_manual(values=formatlines, name="Species", guide=F)+
  scale_colour_manual(values=cbPalette, name="Species", guide=F)+
  theme_bw()

plotwater<-ggplot(data=hemtop10, aes(x=meanWatercontent.standard, y=log(value), group=variable, linetype=variable, colour=variable)) +
  geom_smooth(method=lm, se=F,level=0.95)+
  ylab("Abundance")+ xlab("standardized mean water content")+
  scale_linetype_manual(values=formatlines, name="Species", guide=F)+
  scale_colour_manual(values=cbPalette, name="Species", guide=F)+
  theme_bw()

morph<-glmer.nb(hemtop10$value~hemtop10$morphotype.x+(1+morphotype.x|variable)+(1|site), data=hemtop10)
dotplot(ranef(morph, condVar=T))

par(mfrow=c(2,2))
plotN


grid.arrange(plotSLA,plotwater,plotN,plotP)
```











