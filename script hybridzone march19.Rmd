---
title: "Untitled"
output: html_document
---


---
title: "ch2 4th corner September 2018"
output: html_document
---

<br>
<br>

##Introduction

<br>

Host plant genotype and phenotype influence arthropod community composition. They influence fitness, can mediate competition, predation and host-parasite interactions. Plant size, leaf chemistry, defense compounds, trichome density etc all affect species in different ways. However, it is hard to pin down general principles in how host plant characteristics affect herbivores across species 
Insect traits can be used to provide a mechanistic connection between species and environment. Insect traits have increasingly been used to understand insect response to characteristics of landscape and understand community composition.

<br>

I set out with the following objectives:


##### (i) How do herbivore communities respond to phenotypic variation?
##### (ii) Which plant traits account for herbivore community responses to host-plant phenotype?
##### (iii) Which insect traits account for herbivore community responses to host-plant phenotype



<br>
<br>



```{r }
rm(list=ls())
library(ggplot2)
library(scales)
library(lattice)
library(vegan)
library(iNEXT)
library(plyr)
library(mvabund)
library(reshape2)
library(lme4)

#try species by site dataset, including leps and coleoptera
setwd("/Users/elsketielens/phd/data/HDIM/branch clipping/data/data for R")
hem<-read.table("phyto.march19.juv.csv", header=TRUE, sep="")

##load other datasets 
setwd("/Users/elsketielens/phd/data/HDIM/branch clipping/data/data for R")
env<- read.table("env site july16.csv", header=TRUE, sep=",")
setwd("/Users/elsketielens/phd/data/HDIM/branch clipping/data/data for R")
traits<-read.table("trait species march19.csv", header=T, sep=",")
setwd("/Users/elsketielens/phd/data/HDIM/branch clipping/data/data for R")
leaftraits<-read.table("leaf traits july16.csv", header=TRUE, sep=",")
rownames(env)<-env$vialID
```


```{r}
##############

# Remove hemiptera that are not phytophagous
traits<- traits[traits$spec.code!="NAB_OSC",]
traits<- traits[traits$spec.code!="COC_SP",]
traits<- traits[traits$spec.code!="PHI_SPU",]

hem<- hem[,colnames(hem)!="NAB_OSC",]
hem<- hem[,colnames(hem)!="COC_SP",]
hem<- hem[,colnames(hem)!="PHI_SPU",]
# confirm that was all predators:
table(traits$feeding.guild)
traits$feeding.guild<-factor(traits$feeding.guild)
# make sure to remover predator from the levels, or mvabund will give problems
levels(traits$feeding.guild)


##############


# Subset to include sites in hybrid zones with trees of clear morphotypes: ERO, ALI, KAIY, OLAA

env<-env[env$vialID%in%rownames(hem),]
env.both<-env[env$site=="ERO"|env$site=="ALI"|env$site=="OLAA"|env$site=="KAIY",]
env.both.kaio<-env[env$site=="ERO"|env$site=="ALI"|env$site=="OLAA"|env$site=="KAIY"|env$site=="KAIO",]
env.2014<-env.both[env.both$sampleyear=="2014",]

hem.both<-hem[rownames(hem)%in%env.both$vialID,]
hem.both.kaio<-hem[rownames(hem)%in%env.both.kaio$vialID,]
hem.2014<-hem[rownames(hem)%in%env.2014$vialID,]

# Subset leaftraits to include only sites in hybrid zone:
leaftraits<-leaftraits[leaftraits$vialID%in%env.both$vialID,]


##############


# generate data for nmds plots
env<-env[order(env$vialID),]
hem<-hem[order(as.numeric(rownames(hem))),]

hem.ero<-hem[env$site=="ERO",]
hem.ali<-hem[env$site=="ALI",]
hem.kaiy<-hem[env$site=="KAIY",]
hem.olaa<-hem[env$site=="OLAA",]


##############


# subset traits to only include traits for hem species present at hybrid zone sites
traits<-traits[traits$spec.code%in%colnames(hem.2014),]


hem.2014<-hem.2014[,colnames(hem.2014)%in%traits$spec.code]
hem.both<-hem.both[,colnames(hem.both)%in%traits$spec.code]
hem.both.kaio<-hem.both.kaio[,colnames(hem.both.kaio)%in%traits$spec.code]


# exclude species that don't occur in our four sites
hem.both<-hem.both[,colSums(hem.both)>0]
hem.2014<-hem.2014[,colSums(hem.2014)>0]
##############
```


```{r}
par(mfrow=c(2,2))

moment<-metaMDS(hem.ero, k=3)
mds.fig <- ordiplot(moment, type = "none", main="Escape road old flow")
text(mds.fig, "species")
points(mds.fig, "sites", pch = 19, col = "green", select = env[env$site=="ERO",]$morphotype == "G")
points(mds.fig, "sites", pch = 19, col = "blue", select = env[env$site=="ERO",]$morphotype == "H")
points(mds.fig, "sites", pch = 19, col = "red", select = env[env$site=="ERO",]$morphotype == "P")

Lab<-c("G", "H", "P")
color<-c("green", "blue", "red")
legend(  "topright", legend=Lab,pch=c(22),pt.bg=c(color),pt.cex=1.1,cex=0.9,xpd=TRUE)



moment<-metaMDS(hem.kaiy, k=3)
mds.fig <- ordiplot(moment, type = "none", main="Kaiholena Young flow")
text(mds.fig, "species")
points(mds.fig, "sites", pch = 19, col = "green", select = env[env$site=="KAIY",]$morphotype == "G")
points(mds.fig, "sites", pch = 19, col = "blue", select = env[env$site=="KAIY",]$morphotype == "H")
points(mds.fig, "sites", pch = 19, col = "red", select = env[env$site=="KAIY",]$morphotype == "P")

Lab<-c("G", "H", "P")
color<-c("green", "blue", "red")
legend(  "topright", legend=Lab,pch=c(22),pt.bg=c(color),pt.cex=1.1,cex=0.9,xpd=TRUE)



moment<-metaMDS(hem.ali, k=3)
mds.fig <- ordiplot(moment, type = "none", main="Alili Springs")
text(mds.fig, "species")
points(mds.fig, "sites", pch = 19, col = "green", select = env[env$site=="ALI",]$morphotype == "G")
points(mds.fig, "sites", pch = 19, col = "blue", select = env[env$site=="ALI",]$morphotype == "H")
points(mds.fig, "sites", pch = 19, col = "red", select = env[env$site=="ALI",]$morphotype == "P")

Lab<-c("G", "H", "P")
color<-c("green", "blue", "red")
legend(  "topright", legend=Lab,pch=c(22),pt.bg=c(color),pt.cex=1.1,cex=0.9,xpd=TRUE)




moment<-metaMDS(hem.olaa, k=3)
mds.fig <- ordiplot(moment, type = "none", main="HAVO Olaa")
text(mds.fig, "species")
points(mds.fig, "sites", pch = 19, col = "green", select = env[env$site=="OLAA",]$morphotype == "G")
points(mds.fig, "sites", pch = 19, col = "blue", select = env[env$site=="OLAA",]$morphotype == "H")
points(mds.fig, "sites", pch = 19, col = "red", select = env[env$site=="OLAA",]$morphotype == "P")

Lab<-c("G", "H", "P")
color<-c("green", "blue", "red")
legend(  "topright", legend=Lab,pch=c(22),pt.bg=c(color),pt.cex=1.1,cex=0.9,xpd=TRUE)




adonis(hem.ali~env[env$site=="ALI",]$morphotype, by="margin")
adonis(hem.kaiy~env[env$site=="KAIY",]$morphotype, by="margin")
adonis(hem.ero~env[env$site=="ERO",]$morphotype, by="margin")
adonis(hem.olaa~env[env$site=="OLAA",]$morphotype, by="margin")



```
<br>

## Results

<br>
<br>

#### Some context: Richness across chronosequence
<br>
```{r describe_insect_community, echo=FALSE, warning=FALSE}
ord<-c( "ERO",  "KAIY", "OLAA", "ALI")

plot(ChaoRichness(as.data.frame(t(hem.both)), datatype = "abundance")[,2]~factor(env.both$site, as.ordered(ord)),  ylab="Estimated species richness (chao)", xlab="sites (ordered by substrate age)")
plot(exp(ChaoShannon(as.data.frame(t(hem.both)), datatype = "abundance")[,2])~factor(env.both$site, as.ordered(ord)),  ylab="Exp Estimated Shannon (hill 1)", xlab="sites (ordered by substrate age)")
plot(1/(1-ChaoSimpson(as.data.frame(t(hem.both)), datatype = "abundance")[,2])~factor(env.both$site, as.ordered(ord)),  ylab="1/1-Estimated Simpson (hill 2)", xlab="sites (ordered by substrate age)")

```

<br>

#### (i) How do herbivore communities respond to phenotypic variation?

<br>
<br>

There are differences in species richness as well as species composition across sites. Diversity is highest at the high productivity sites midway the Big Island chronosequence. Species composition varies between sites, though many species are shared in common.  
<br>


#### (ii) Which plant traits account for herbivore community responses to host-plant phenotype?



<br>

```{r Cor}


adonis(hem.2014~leaftraits$morphotype+leaftraits$percN+leaftraits$meanWatercontent+leaftraits$meanSLA+leaftraits$percP, by="margin")


adonis(hem.2014~env.2014$tree.height+leaftraits$morphotype+leaftraits$meanSLA+leaftraits$percN+env.2014$tree.height+env.2014$site, by="margin")



mod.leaf<-cca(hem.2014~leaftraits$percN+leaftraits$morphotype+leaftraits$meanSLA+leaftraits$meanWatercontent+leaftraits$percP)
mod.leaf.age<-cca(hem.2014~leaftraits$percN+leaftraits$morphotype+leaftraits$meanSLA+env.2014$age)
mod.leaf.tree<-cca(hem.2014~leaftraits$percN+leaftraits$morphotype+leaftraits$meanSLA+env.2014$tree.height)
mod.leaf.age.site<-cca(hem.2014~leaftraits$percN+leaftraits$morphotype+leaftraits$meanSLA+env.2014$tree.height+env.2014$age+env.2014$site)
mod.leaf.site<-cca(hem.2014~leaftraits$percN+leaftraits$morphotype+leaftraits$meanSLA+env.2014$site+leaftraits$meanWatercontent+leaftraits$percP)

# compare contribution of different predictors
mod.leaf
mod.leaf.age
mod.leaf.tree
mod.leaf.site
mod.leaf.age.site


plot(mod.leaf, type="none")
points(mod.leaf, display="sites")
text(mod.leaf, display="species")

anova(mod.leaf.age.site, by = "margin", step=200 )



ordiplot(mod.leaf)
ordiplot(mod.leaf.age)

# spread into hybrid versus pubescent/glabrous is explained by SLA, tree height Spread between pubescent and glabrous explained by age 




plot(mod.leaf.age.site, type="none")
points(mod.leaf.age.site, display="sites")
#text(mod, display="species")
plot(envfit(mod.leaf.age.site, leaftraits[, c(1,3,4)]))



vare.cca <- cca(decostand(hem.2014, "total") ~ ., data = leaftraits[,c(1,6)]) 

plot(vare.cca, display = "sites", scaling = 3, type="points")
text(vare.cca, scaling = 3, display = "bp", pch=4) 
text(vare.cca, display = "species", scaling = 3, col="red")



leaftraits.new<-leaftraits[leaftraits$vialID%in%env.yng$vialID,]
leaftraits.new<-merge(leaftraits.new,env.yng, by="vialID")
```

<br>

#### (iii) Which insect traits account for herbivore community responses to host-plant phenotype
<br>

 What are the frequencies of feeding guilds and other insect traits as a function of host plant traits?

<br>

##### Feeding guild per morphotype

<br>
```{r Trait_by_trait, echo=FALSE}
# use hem.freq

# next figure out which rows have H morphotype, and then sum all freq for which guild is seed and morpho is H
leaftraits$vialID<-rownames(leaftraits)
leaftraits<-leaftraits[order((leaftraits$vialID)),]
hem.2014$vialID<-rownames(hem.2014)
hem.2014<-hem.2014[order(hem.2014$vialID),]


leaftraits<-leaftraits[order((leaftraits$vialID)),]
hem.2014$vialID<-rownames(hem.2014)
hem.2014<-hem.2014[order(hem.2014$vialID),]
hem.2014<-hem.2014[,-39]

temp<-data.frame(NA, ncol=3, nrow=9)

temp[1,1]<-
  mean(hem.2014[ rownames(hem.2014)[leaftraits$morphotype=="H"]  ,rownames(traits)[traits$feeding_guild=="seed"] ])
temp[2,1]<-
mean(hem.2014[ rownames(hem.2014)[leaftraits$morphotype=="P"]  ,rownames(traits)[traits$feeding_guild=="seed"] ])
temp[3,1]<-
mean(hem.2014[ rownames(hem.2014)[leaftraits$morphotype=="G"]  ,rownames(traits)[traits$feeding_guild=="seed"] ])

temp[4,1]<-
mean(rowSums(hem.2014[ rownames(hem.2014)[leaftraits$morphotype=="H"]  ,rownames(traits)[traits$feeding_guild=="sap feeder"] ]))
temp[5,1]<-
mean(rowSums(hem.2014[ rownames(hem.2014)[leaftraits$morphotype=="P"]  ,rownames(traits)[traits$feeding_guild=="sap feeder"] ]))
temp[6,1]<-
mean(rowSums(hem.2014[ rownames(hem.2014)[leaftraits$morphotype=="G"]  ,rownames(traits)[traits$feeding_guild=="sap feeder"] ]))

temp[7,1]<-
mean(rowSums(hem.2014[ rownames(hem.2014)[leaftraits$morphotype=="H"]  ,rownames(traits)[traits$feeding_guild=="chewer"] ]))
temp[8,1]<-
mean(rowSums(hem.2014[ rownames(hem.2014)[leaftraits$morphotype=="P"]  ,rownames(traits)[traits$feeding_guild=="chewer"] ]))
temp[9,1]<-
mean(rowSums(hem.2014[ rownames(hem.2014)[leaftraits$morphotype=="G"]  ,rownames(traits)[traits$feeding_guild=="chewer"] ]))

temp[10,1]<-
mean(rowSums(hem.2014[ rownames(hem.2014)[leaftraits$morphotype=="H"]  ,rownames(traits)[traits$feeding_guild=="gall"] ]))
temp[11,1]<-
mean(rowSums(hem.2014[ rownames(hem.2014)[leaftraits$morphotype=="P"]  ,rownames(traits)[traits$feeding_guild=="gall"] ]))
temp[12,1]<-
mean(rowSums(hem.2014[ rownames(hem.2014)[leaftraits$morphotype=="G"]  ,rownames(traits)[traits$feeding_guild=="gall"] ]))

temp[,2]<-"seed"
temp[c(4,5,6),2]<-"sap feeder"
temp[c(7,8,9),2]<-"chewer"
temp[c(10,11,12),2]<-"gall"

temp[c(1,4,7,10),3]<-"H"
temp[c(2,5,8,11),3]<-"P"
temp[c(3,6,9,12),3]<-"G"

#temp<-as.data.frame(temp)
colnames(temp)<-c("freq", "feeding.guild", "morphotype")
#temp$freq<-as.numeric(temp$freq)



fig.alt0<-ggplot(data=temp, aes(x=(morphotype), y=freq, fill=feeding.guild, na.omit=TRUE)) +
  geom_bar(stat="identity", width=0.2)+
  theme(axis.text.x=element_text(hjust=1,vjust=0.5))+
  ylab("Abundance of individuals in each feeding guild") +
  xlab("tree morphotype")


fig.alt0
```
<br>

Frequency of different feeding guilds differs between tree morphotypes. Glabrous morphotypes are dominated by sap feeders and leaf chewers, and few galls. Pubescent morphotypes have higher proportions of gall makers and seed feeders.  




<br>

##### Location nymph
<br>
```{r location_nymph, echo=FALSE}

nymph.morpho<-data.frame(NA, ncol=2, nrow=6)

nymph.morpho[1,1]<-
  mean(rowSums(hem.2014[ rownames(hem.2014)[leaftraits$morphotype=="H"]  ,rownames(traits)[traits$location_nymph=="free living"] ]))
nymph.morpho[2,1]<-
mean(rowSums(hem.2014[ rownames(hem.2014)[leaftraits$morphotype=="P"]  ,rownames(traits)[traits$location_nymph=="free living"] ]))
nymph.morpho[3,1]<-
mean(rowSums(hem.2014[ rownames(hem.2014)[leaftraits$morphotype=="G"]  ,rownames(traits)[traits$location_nymph=="free living"] ]))


nymph.morpho[4,1]<-mean(rowSums(hem.2014[ rownames(hem.2014)[leaftraits$morphotype=="H"]  ,rownames(traits)[traits$location_nymph=="subterranean"] ]))
nymph.morpho[5,1]<-
mean(rowSums(hem.2014[ rownames(hem.2014)[leaftraits$morphotype=="P"]  ,rownames(traits)[traits$location_nymph=="subterranean"] ]))
nymph.morpho[6,1]<-
mean(rowSums(hem.2014[ rownames(hem.2014)[leaftraits$morphotype=="G"]  ,rownames(traits)[traits$location_nymph=="subterranean"] ]))

nymph.morpho[7,1]<-
mean(rowSums(hem.2014[ rownames(hem.2014)[leaftraits$morphotype=="H"]  ,rownames(traits)[traits$location_nymph=="gall"] ]))
nymph.morpho[8,1]<-
mean(rowSums(hem.2014[ rownames(hem.2014)[leaftraits$morphotype=="P"]  ,rownames(traits)[traits$location_nymph=="gall"] ]))
nymph.morpho[9,1]<-
mean(rowSums(hem.2014[ rownames(hem.2014)[leaftraits$morphotype=="G"]  ,rownames(traits)[traits$location_nymph=="gall"] ]))

nymph.morpho[10,1]<-
mean(hem.2014[ rownames(hem.2014)[leaftraits$morphotype=="H"]  ,rownames(traits)[traits$location_nymph=="shelter"] ])
nymph.morpho[11,1]<-
mean(hem.2014[ rownames(hem.2014)[leaftraits$morphotype=="P"]  ,rownames(traits)[traits$location_nymph=="shelter"] ])
nymph.morpho[12,1]<-
mean(hem.2014[ rownames(hem.2014)[leaftraits$morphotype=="G"]  ,rownames(traits)[traits$location_nymph=="shelter"] ])



nymph.morpho[,2]<-"free living"
nymph.morpho[c(4,5,6),2]<-"subterranean"
nymph.morpho[c(7,8,9),2]<-"gall"
nymph.morpho[c(10,11,12),2]<-"shelter"

nymph.morpho[c(1,4,7,10),3]<-"H"
nymph.morpho[c(2,5,8,11),3]<-"P"
nymph.morpho[c(3,6,9,12),3]<-"G"

#nymph.morpho<-as.data.frame(temp)
colnames(nymph.morpho)<-c("freq", "location.nymph", "morphotype")

fig.alt<-ggplot(data=nymph.morpho, aes(x=(morphotype), y=freq, fill=location.nymph, na.omit=TRUE)) +
  geom_bar(stat="identity", width=0.2)+
  theme(axis.text.x=element_text(hjust=1,vjust=0.5))+
  ylab("Abundance of individuals for each location nymph") +
  xlab("tree morphotype")

fig.alt
```
<br>
Glabrous morphotype trees are dominated by free living nymphs. Hybrid morphotypes have higher proportions gall makers. Pubescent morphotype trees have predominately free living juveniles with ~20% gall makers, highest proportion galls of all morphotypes. Hyposmocoma (only taxa coded as 'shelter') occur almost exclusively on glabrous morphotypes. Cixiidae (subterranean) are found predominately on pubescent morphotypes. 

<br>
##### Specialist/generalist
<br>
```{r specialization, echo=FALSE}
special<-data.frame(NA, ncol=2, nrow=6)

special[1,1]<-
  mean(rowSums(hem.2014[ rownames(hem.2014)[leaftraits$morphotype=="H"]  ,rownames(traits)[traits$polyphagy=="specialist"] ]))
special[2,1]<-
mean(rowSums(hem.2014[ rownames(hem.2014)[leaftraits$morphotype=="P"]  ,rownames(traits)[traits$polyphagy=="specialist"] ]))
special[3,1]<-
mean(rowSums(hem.2014[ rownames(hem.2014)[leaftraits$morphotype=="G"]  ,rownames(traits)[traits$polyphagy=="specialist"] ]))

special[4,1]<-
mean(rowSums(hem.2014[ rownames(hem.2014)[leaftraits$morphotype=="H"]  ,rownames(traits)[traits$polyphagy=="generalist"] ]))
special[5,1]<-
mean(rowSums(hem.2014[ rownames(hem.2014)[leaftraits$morphotype=="P"]  ,rownames(traits)[traits$polyphagy=="generalist"] ]))
special[6,1]<-
mean(rowSums(hem.2014[ rownames(hem.2014)[leaftraits$morphotype=="G"]  ,rownames(traits)[traits$polyphagy=="generalist"] ]))


special[,2]<-"specialist"
special[c(4,5,6),2]<-"generalist"


special[c(1,4),3]<-"H"
special[c(2,5),3]<-"P"
special[c(3,6),3]<-"G"

colnames(special)<-c("freq", "specialism", "morphotype")

#######
########
#special<-data.frame(NA, ncol=2, nrow=6)

#special[1,1]<-
#  mean(rowSums(hem.2014[ rownames(hem.2014)[leaftraits$morphotype=="H"]  #,rownames(traits)[traits$polyphagy=="specialist"] ]))
#special[2,1]<-
#mean(rowSums(hem.2014[ rownames(hem.2014)[leaftraits$morphotype=="P"]  ,rownames(traits)[traits$polyphagy=="specialist"] ]))
#special[3,1]<-
#mean(rowSums(hem.2014[ rownames(hem.2014)[leaftraits$morphotype=="G"]  ,rownames(traits)[traits$polyphagy=="specialist"] ]))

#special[4,1]<-
#mean(rowSums(hem.2014[ rownames(hem.2014)[leaftraits$morphotype=="H"]  ,rownames(traits)[traits$polyphagy=="generalist"] ]))
#special[5,1]<-
#mean(rowSums(hem.2014[ rownames(hem.2014)[leaftraits$morphotype=="P"]  ,rownames(traits)[traits$polyphagy=="generalist"] ]))
#special[6,1]<-
#mean(rowSums(hem.2014[ rownames(hem.2014)[leaftraits$morphotype=="G"]  ,rownames(traits)[traits$polyphagy=="generalist"] ]))


#special[,2]<-"specialist"
#special[c(4,5,6),2]<-"generalist"
#
#######
######

fig.alt2<-ggplot(data=special, aes(x=(morphotype), y=freq, fill=specialism, na.omit=TRUE)) +
  geom_bar(stat="identity", width=0.2)+
  theme(axis.text.x=element_text(hjust=1,vjust=0.5))+
  ylab("Abundance of individuals for each degree of specialization") +
  xlab("tree morphotype")

fig.alt2


```
<br>

For glabrous and hybrid morphotype trees, one third of the community are generalists, and two thirds are specialists. For pubescent morphotype trees, communities have even higher proportions specialists.

<br>

##### Feeding guilds as a function of leaf nitrogen

<br>
```{r feeding_guild_N, echo=FALSE, warning=FALSE}
######
#How do proportions of each feeding guild vary across leaf nitrogen content?

#hem.freq<-hem.freq[,-27]


#guilds.per.site<-data.frame("site"=1:55)
#subsetted.sap<-hem.new[,colnames(hem.new)[traits$feeding_guild=="sap feeder"]] 
#guilds.per.site[,1]<-rowSums(subsetted.sap)
#guilds.per.site[,2]<-rownames(hem.new)
#guilds.per.site[,3]<-"sap"
#guilds.per.site2<-data.frame("site"=1:55)
#subsetted.chewer<-hem.new[,colnames(hem.new)[traits$feeding_guild=="chewer"]] 
#guilds.per.site2[,1]<-rowSums(subsetted.chewer)
#guilds.per.site2[,2]<-rownames(hem.new)
#guilds.per.site2[,3]<-"chewer"
#guilds.per.site3<-data.frame("site"=1:55)
#guilds.per.site3[,1]<-hem.new[,colnames(hem.new)[traits$feeding_guild=="seed"]] 
#guilds.per.site3[,2]<-rownames(hem.new)
#guilds.per.site3[,3]<-"seed"
#guilds.per.site4<-data.frame("site"=1:55)
#guilds.per.site4[,1]<-hem.new[,colnames(hem.new)[traits$feeding_guild=="gall"]] 
#guilds.per.site4[,2]<-rownames(hem.new)
#guilds.per.site4[,3]<-"gall"
#guilds<-rbind(guilds.per.site,guilds.per.site2, guilds.per.site3, guilds.per.site4)
#colnames(guilds)<-c("abundance", "vialID", "feeding_guild")
#guilds2<-merge(guilds, leaftraits[,c(1,7)])






#ggplot(guilds2, aes(x=percN, y=abundance+1, color=feeding_guild)) +
#    geom_point(shape=1) +
#  scale_y_log10("Abundance (log)")+
#    scale_colour_hue(l=50) + # Use a slightly darker palette than normal
#    geom_smooth(method=lm, se=FALSE) 



#anova(lm(abundance[feeding_guild=="chewer"]~percN[feeding_guild=="chewer"],data=guilds2))
#anova(lm(abundance[feeding_guild=="sap"]~percN[feeding_guild=="sap"],data=guilds2))
#anova(lm(abundance[feeding_guild=="seed"]~percN[feeding_guild=="seed"],data=guilds2))
#anova(lm(abundance[feeding_guild=="gall"]~percN[feeding_guild=="gall"],data=guilds2))

# restore leaftraits to not have vialID
leaftraits<-leaftraits[,-7]
```
<br>
Arthropod abundance per feeding guild varies across leaf nitrogen content. Leaf chewers increase in abundance with nitrogen content, and this increase is significant. Abundance of sap feeders also increases with percN, but the spread is large and this increase is not significant. Abundance of gall makers is not correlated with nitrogen content, and abundance of seed feeders decreases non-significantly with foliar nitrogen content.

<br>

Are communities distinctly different between different morphotype trees across all youngish sites?
```{r}

moment<-metaMDS(hem.both, k=3)
mds.fig <- ordiplot(moment, type = "none", main="all hybrid zone sites")
text(mds.fig, "species")
points(mds.fig, "sites", pch = 19, col = "green", select = env.both$morphotype == "G")
points(mds.fig, "sites", pch = 19, col = "blue", select = env.both$morphotype == "H")
points(mds.fig, "sites", pch = 19, col = "red", select = env.both$morphotype == "P")

Lab<-c("Glabrous", "Hybrid", "Pubescent")
color<-c("green", "blue", "red")
legend(  "topright", legend=Lab,pch=c(22),pt.bg=c(color),pt.cex=1.1,cex=0.9,xpd=TRUE)



```
<br>


<br>

Are communities distinctly different between different morphotype trees within the same site?

<br>

```{r}
par(mfrow=c(2,2))

moment<-metaMDS(hem.ero, k=3)
mds.fig <- ordiplot(moment, type = "none", main="Escape road old flow")
text(mds.fig, "species")
points(mds.fig, "sites", pch = 19, col = "green", select = env[env$site=="ERO",]$morphotype == "G")
points(mds.fig, "sites", pch = 19, col = "blue", select = env[env$site=="ERO",]$morphotype == "H")
points(mds.fig, "sites", pch = 19, col = "red", select = env[env$site=="ERO",]$morphotype == "P")

Lab<-c("G", "H", "P")
color<-c("green", "blue", "red")
legend(  "topright", legend=Lab,pch=c(22),pt.bg=c(color),pt.cex=1.1,cex=0.9,xpd=TRUE)



moment<-metaMDS(hem.kaiy, k=3)
mds.fig <- ordiplot(moment, type = "none", main="Kaiholena Young flow")
text(mds.fig, "species")
points(mds.fig, "sites", pch = 19, col = "green", select = env[env$site=="KAIY",]$morphotype == "G")
points(mds.fig, "sites", pch = 19, col = "blue", select = env[env$site=="KAIY",]$morphotype == "H")
points(mds.fig, "sites", pch = 19, col = "red", select = env[env$site=="KAIY",]$morphotype == "P")

Lab<-c("G", "H", "P")
color<-c("green", "blue", "red")
legend(  "topright", legend=Lab,pch=c(22),pt.bg=c(color),pt.cex=1.1,cex=0.9,xpd=TRUE)



moment<-metaMDS(hem.ali, k=3)
mds.fig <- ordiplot(moment, type = "none", main="Alili Springs")
text(mds.fig, "species")
points(mds.fig, "sites", pch = 19, col = "green", select = env[env$site=="ALI",]$morphotype == "G")
points(mds.fig, "sites", pch = 19, col = "blue", select = env[env$site=="ALI",]$morphotype == "H")
points(mds.fig, "sites", pch = 19, col = "red", select = env[env$site=="ALI",]$morphotype == "P")

Lab<-c("G", "H", "P")
color<-c("green", "blue", "red")
legend(  "topright", legend=Lab,pch=c(22),pt.bg=c(color),pt.cex=1.1,cex=0.9,xpd=TRUE)




moment<-metaMDS(hem.olaa, k=3)
mds.fig <- ordiplot(moment, type = "none", main="HAVO Olaa")
text(mds.fig, "species")
points(mds.fig, "sites", pch = 19, col = "green", select = env[env$site=="OLAA",]$morphotype == "G")
points(mds.fig, "sites", pch = 19, col = "blue", select = env[env$site=="OLAA",]$morphotype == "H")
points(mds.fig, "sites", pch = 19, col = "red", select = env[env$site=="OLAA",]$morphotype == "P")

Lab<-c("G", "H", "P")
color<-c("green", "blue", "red")
legend(  "topright", legend=Lab,pch=c(22),pt.bg=c(color),pt.cex=1.1,cex=0.9,xpd=TRUE)




adonis(hem.ali~env[env$site=="ALI",]$morphotype, by="margin")
adonis(hem.kaiy~env[env$site=="KAIY",]$morphotype, by="margin")
adonis(hem.ero~env[env$site=="ERO",]$morphotype, by="margin")
adonis(hem.olaa~env[env$site=="OLAA",]$morphotype, by="margin")


#############################



#ggplot(data=temp4, aes(x=site, y=morphN, fill=morphotype)) +
 #   geom_bar(stat="identity", position=position_dodge(), colour="black")
#ggplot(data=temp4, aes(x=site, y=morphP, fill=morphotype)) +
#    geom_bar(stat="identity", position=position_dodge(), colour="black")
#ggplot(data=temp4, aes(x=site, y=morphSLA, fill=morphotype)) +
#    geom_bar(stat="identity", position=position_dodge(), colour="black")
#ggplot(data=temp4, aes(x=site, y=morphwater, fill=morphotype)) +
#    geom_bar(stat="identity", position=position_dodge(), colour="black")


ggplot(data=leaftraits, aes(x=env.2014$site, y=percN, color=morphotype)) +
    geom_point()
ggplot(data=leaftraits, aes(x=env.2014$site, y=percP, color=morphotype)) +
    geom_point()
ggplot(data=leaftraits, aes(x=env.2014$site, y=meanSLA, color=morphotype)) +
    geom_point()
ggplot(data=leaftraits, aes(x=env.2014$site, y=meanWatercontent, color=morphotype)) +
    geom_point()

### perc N

anova(lm(leaftraits$percN~leaftraits$morphotype*env.2014$site))
TukeyHSD(aov(leaftraits$percN~leaftraits$morphotype*env.2014$site))

anova(lm(leaftraits$percN~env.2014$site))
TukeyHSD(aov(leaftraits$percN~env.2014$site))

### perc P

anova(lm(leaftraits$percP~leaftraits$morphotype))
TukeyHSD(aov(leaftraits$percP~leaftraits$morphotype))

anova(lm(leaftraits$percP~env.2014$site))
TukeyHSD(aov(leaftraits$percP~env.2014$site))



### mean SLA
anova(lm(leaftraits$meanSLA~leaftraits$morphotype))
TukeyHSD(aov(leaftraits$meanSLA~leaftraits$morphotype))

anova(lm(leaftraits$meanSLA~env.2014$site))
TukeyHSD(aov(leaftraits$meanSLA~env.2014$site))


### mean water
anova(lm(leaftraits$meanWatercontent~leaftraits$morphotype))
TukeyHSD(aov(leaftraits$meanWatercontent~leaftraits$morphotype))

#anova(lm(leaftraits$meanWatercontent~env.2014$site))
#TukeyHSD(aov(leaftraits$meanWatercontent~env.2014$site))


```

#

adonis(hem.2014 ~  leaftraits$percN +leaftraits$percP+leaftraits$morphotype  + leaftraits$meanWatercontent +leaftraits$meanSLA +env.2014$site , by="terms")

# phosphorus and morphotype are only sig when only/first term
# mean SLA and mean water content are always sig no matter their placement
# perc N significant unless after SLA and before water content



```{r}

#summary(lmer(ChaoRichness(as.data.frame(t(hem[rownames(hem) %in% temp5$vialID,])))[,2]~temp5$morphotype+temp5$percN+temp5$percP+temp5$meanSLA+temp5$meanWatercontent+(1|temp5$site)))

#summary(lmer(ChaoSimpson(as.data.frame(t(hem.comp)))[,2]~env.comp$morphotype+(1|env.comp$site)))


#summary(lmer(ChaoSimpson(as.data.frame(t(hem[rownames(hem) %in% temp5$vialID,])))[,2]~temp5$morphotype+(1|temp5$site)))

#adonis(hem.comp~env.comp$morphotype)

#summary(lmer(rowSums(hem[rownames(hem) %in% temp5$vialID,])~temp5$morphotype+(1|temp5$site)))
#summary(lmer(rowSums(hem[rownames(hem) %in% temp5$vialID,])~temp5$percN+(1|temp5$site)))
#summary(lmer(rowSums(hem[rownames(hem) %in% temp5$vialID,])~temp5$percP+(1|temp5$site)))
#summary(lmer(rowSums(hem[rownames(hem) %in% temp5$vialID,])~temp5$meanSLA+(1|temp5$site)))
#summary(lmer(rowSums(hem[rownames(hem) %in% temp5$vialID,])~temp5$meanWatercontent+(1|temp5$site)))
```

<br>
What does diversity and abundance look like across these sites with multiple phenotypes?
```{r}
plot(1/(1-ChaoSimpson(as.data.frame(t(hem.ero)) )[,2])~env[env$site=="ERO",]$morphotype)
plot(1/(1-ChaoSimpson(as.data.frame(t(hem.kaiy)) )[,2])~env[env$site=="KAIY",]$morphotype)
plot(1/(1-ChaoSimpson(as.data.frame(t(hem.olaa)) )[,2])~env[env$site=="OLAA",]$morphotype)
plot(1/(1-ChaoSimpson(as.data.frame(t(hem.ali)) )[,2])~env[env$site=="ALI",]$morphotype)

plot(ChaoRichness(as.data.frame(t(hem.ero)) )[,2]~env[env$site=="ERO",]$morphotype)
plot(ChaoRichness(as.data.frame(t(hem.kaiy)) )[,2]~env[env$site=="KAIY",]$morphotype)
plot(ChaoRichness(as.data.frame(t(hem.olaa)) )[,2]~env[env$site=="OLAA",]$morphotype)
plot(ChaoRichness(as.data.frame(t(hem.ali)) )[,2]~env[env$site=="ALI",]$morphotype)

plot(rowSums(hem.ero)~env[env$site=="ERO",]$morphotype)
plot(rowSums(hem.kaiy)~env[env$site=="KAIY",]$morphotype)
plot(rowSums(hem.olaa)~env[env$site=="OLAA",]$morphotype)
plot(rowSums(hem.ali)~env[env$site=="ALI",]$morphotype)

anova(lm(1/(1-ChaoSimpson(as.data.frame(t(hem.ero)) )[,2])~env[env$site=="ERO",]$morphotype))
#anova(lm(1/(1-ChaoSimpson(as.data.frame(t(hem.kaiy)) )[,2])~env[env$site=="KAIY",]$morphotype))
anova(lm(1/(1-ChaoSimpson(as.data.frame(t(hem.olaa)) )[,2])~env[env$site=="OLAA",]$morphotype))
anova(lm(1/(1-ChaoSimpson(as.data.frame(t(hem.ali)) )[,2])~env[env$site=="ALI",]$morphotype))

anova(lm(rowSums(hem.kaiy)~env[env$site=="KAIY",]$morphotype))
# p<0.05
anova(lm(rowSums(hem.olaa)~env[env$site=="OLAA",]$morphotype))
# p<0.1


# Across all 12 sites:
env.both$morphotype<-factor(env.both$morphotype, levels=c("H", "G", "P"))
plot(rowSums(hem.both)~env.both$morphotype, ylim=c(0,300), ylab="Abundance")
anova(lm(rowSums(hem.both)~env.both$morphotype))
TukeyHSD(aov(rowSums(hem.both)~env.both$morphotype))
# p<0.05

tem<-1-ChaoSimpson(as.data.frame(t(hem.both), na.rm=TRUE) )
#tem[10,2]<-1
#tem[65,2]<-1
tem<-ifelse(tem[,2]==0,0,1/tem[,2])
anova(lm(tem~env.both$morphotype))
anova(lmer(tem~env.both$morphotype+(1|env.both$site)))

tem<-exp(ChaoShannon(as.data.frame(t(hem.both)) )[,2])
#tem[2]<-1
#tem[26]<-1 
anova(lm(tem~env.both$morphotype))
anova(lmer(tem~env.both$morphotype+(1|env.both$site)))

tem<-ChaoRichness(as.data.frame(t(hem.both)))[,2]
anova(lm(tem~env.both$morphotype))
anova(lmer(tem~env.both$morphotype+(1|env.both$site)))
plot(tem~env.both$morphotype, ylab="Species Richness")

# richness does diff sig between morphotype, diversity shannon or simpson does not.
# ie the difference between glabrous and hybrid and glabrous and pubescent is in rare species- glabrous has more rare species than the other two morphotypes, but once you weigh rare species less, there are no differences in diversity



### plots for all sites
plot(diversity(hem)/log(specnumber(hem))~env$morphotype, ylab="Pielou's Evenness")
plot(rowSums(hem)~env$morphotype,  ylab="Abundance",xlab="Tree morphotype", main="across big island (n=170)", ylim=c(0,350))

tem<-exp(ChaoShannon(as.data.frame(t(hem)) )[,2])
plot(tem~env$morphotype, ylab="Exp Shannon Index",main="across big island (n=170)", xlab="Tree morphotype")
```

<br>


```{r}
#mod.leaf.site<-cca(hem.2014~leaftraits$percN+leaftraits$morphotype+leaftraits$meanSLA+leaftraits$meanWatercontent+leaftraits$percP+env.2014$site, na.rm=TRUE)


#mod.leaf.site
# 56% of variation constrained

#mod.leaf<-cca(hem.2014~leaftraits$percN+leaftraits$morphotype+leaftraits$meanSLA+leaftraits$meanWatercontent+leaftraits$percP)
mod.leaf


#plot(mod.leaf.site, type="none")
#points(mod.leaf.site, display="sites")
#text(mod.leaf.site, display="species")
#plot(envfit(mod.leaf.site, temp5[,c(3,4,5,6,8)]))

#anova(mod.leaf.site, by = "margin", step=200 )


```

<br>


```{r fourth1}
library(mvabund)


traits$feeding_guild<-factor(traits$feeding_guild)
leaftraits<-leaftraits[order(rownames(leaftraits)),]
hem.2014<-hem.2014[order(rownames(hem.2014)),]
hem.2014<-hem.2014[,colnames(hem.2014)%in%rownames(traits)]

mod<-manyglm(mvabund(hem.2014)~leaftraits$percN+leaftraits$percP+leaftraits$morphotype+leaftraits$meanWatercontent+leaftraits$meanSLA, family="poisson")

library(lattice)
a        = max( abs(mod$coefficients) )
colort   = colorRampPalette(c("blue","white","red")) 
plot.spp = levelplot(as.matrix(mod$coefficients), xlab="Environmental Variables",
 ylab="Species traits", col.regions=colort(100), at=seq(-a, a, length=100),
 scales = list( x= list(rot = 45)))

plot.spp


```

#### 2d) Test strength of correlation between insect traits and host plant characteristics?

<br>
<br>

```{r fourth2}
# can't handle NAs, will remove and then give error for not matching number of rows
traits[1,]<-c(as.numeric(3), "sap feeder", "free living", "specialist")
traits$length<-as.numeric(traits$length)


ftspp1=traitglm(hem.2014,leaftraits,method="glm1path", family="negative.binomial")

library(lattice)
a        = max( abs(ftspp1$fourth.corner) )
colort   = colorRampPalette(c("blue","white","red")) 
plot.spp = levelplot(t(as.matrix(ftspp1$fourth.corner)), xlab="Environmental Variables",
 ylab="Species traits", col.regions=colort(100), at=seq(-a, a, length=100),
 scales = list( x= list(rot = 45)))

print(plot.spp)




#levels(traits$polyphagy)<-c(levels(traits$polyphagy) ,"zgeneralist")
#traits$polyphagy[traits$polyphagy=="generalist"]<-"zgeneralist"
#traits$polyphagy<-factor(traits$polyphagy)
#levels(traits$polyphagy)

######################


hem.sub<-hem.2014[,colnames(hem.2014)%in%rownames(traits)]
traits<-traits[rownames(traits)%in%colnames(hem.sub),]
traits<-traits[order(rownames(traits)),]
hem.sub<-hem.sub[,order(colnames(hem.sub))]
# Run 4th corner model
model4th<-traitglm(hem.2014, leaftraits[,c(1,2,3,4,6)], traits,  method="manyglm", family="negative.binomial")

# call coefficients
model4th$fourth

# plot coefficients
a        = max( abs(model4th$fourth.corner),na.rm=T )
colort   = colorRampPalette(c("blue","white","red")) 
plot.4th = levelplot(t(as.matrix(model4th$fourth.corner)), xlab="Host Plant Traits",
              ylab="Species traits", col.regions=colort(100), at=seq(-a, a, length=100),
                     scales = list( x= list(rot = 45), fontface="bold"))


print(plot.4th)

colnames(leaftraits)<-c("% Nitrogen", "% Phosphorus", "trichomes -", "SLA", "watercontent", "C:N")
levels(leaftraits$`trichomes -`)<-c(levels(leaftraits$`trichomes -`), "none","intermediate", "high")
leaftraits$`trichomes -`[leaftraits$`trichomes -`=="G"]<- "none"
leaftraits$`trichomes -`[leaftraits$`trichomes -`=="H"]<- "intermediate"
leaftraits$`trichomes -`[leaftraits$`trichomes -`=="P"]<- "high"
leaftraits$`trichomes -`<-factor(leaftraits$`trichomes -`)


colnames(traits)<-c("length", "feeding guild - ", "location nymph - ", "hosts - ")
levels(traits$`hosts:`)<-c(levels(traits$`hosts:`), "generalist","specialist")
traits$`hosts:`[traits$`hosts:`=="zgeneralist"]<-"generalist"
traits$`hosts:`<-factor(traits$`hosts:`)
traits$`hosts:`<-factor(traits$`hosts:`,levels=c("specialist", "generalist"))




######################



ftSmall=traitglm(hem.sub,leaftraits[,c(1,2,3,4,6)],traits)
anova.traitglm(ftSmall, nBoot=999, show.time=T)
# does permutations = work for this function?

model4th<-traitglm(hem.sub, leaftraits, traits,  method="glm1path", family="negative.binomial")
model4th$fourth

```





```{r}
hem.both$vialID<-rownames(hem.both)
hem.both.long<-melt(hem.both)
hem.both.long<-merge(env.both, hem.both.long, by="vialID")

hem.2014$vialID<-rownames(hem.2014)
leaftraits$vialID<-rownames(leaftraits)
hem.2014.long<-melt(hem.2014)
hem.2014.long<-merge(leaftraits, hem.2014.long, by="vialID")



mod.season    =glmer(value    ~morphotype    +(1+morphotype|variable),  data    =hem.both.long,   family    =poisson)
dotplot(ranef(mod.season,    condVar    =T))
summary(mod.season)

mod.no.season    =glmer(value    ~morphotype    +(1|variable),    data    =hem.both.long,family  =poisson)
anova(mod.season,    mod.no.season)


hem.2014.long$percN.standard<-(hem.2014.long$percN-mean(hem.2014.long$percN))/sd(hem.2014.long$percN)
hem.2014.long$percP.standard<-(hem.2014.long$percP-mean(hem.2014.long$percP))/sd(hem.2014.long$percP)
hem.2014.long$meanSLA.standard<-(hem.2014.long$meanSLA-mean(hem.2014.long$meanSLA))/sd(hem.2014.long$meanSLA)
hem.2014.long$meanWatercontent.standard<-(hem.2014.long$meanWatercontent-mean(hem.2014.long$meanWatercontent))/sd(hem.2014.long$meanWatercontent)


# not enough datapoints for all predictors, only include half
mod.leaf    =glmer(value    ~morphotype +percN.standard+meanSLA.standard   +(1+morphotype+percN.standard+meanSLA.standard|variable),  data    =hem.2014.long,   family    =poisson)
dotplot(ranef(mod.leaf,    condVar    =T))
summary(mod.season)

mod.no.leaf    =glmer(value    ~morphotype   +percN.standard+meanSLA.standard +(1|variable),    data    =hem.2014.long,family  =poisson)
anova(mod.leaf,    mod.no.leaf)
# model with species specific intercept is better


# check for other half predictors
mod.leaf.2    =glmer(value    ~percP.standard+meanWatercontent.standard   +(1+percP.standard+meanWatercontent.standard|variable),  data    =hem.2014.long,   family    =poisson)
summary(mod.leaf.2)

anova(mod.leaf.2,    mod.leaf,mod.no.leaf)

dotplot(ranef(mod.leaf.2,    condVar    =T))

mod.leaf.2    =glmer(value    ~percP.standard+meanWatercontent.standard   +(1+percP.standard+meanWatercontent.standard|variable),  data    =hem.2014.long,   family    =poisson)
summary(mod.leaf.2)


mod1    =glmer(value    ~percP.standard+meanWatercontent.standard +morphotype  +(1+percP.standard+meanWatercontent.standard+morphotype|variable),  data    =hem.2014.long,   family    =poisson)
anova(mod.leaf,mod.leaf.2,mod1)
mod2    =glmer(value    ~percP.standard+meanWatercontent.standard + percN.standard+meanSLA.standard +(1+percP.standard+meanWatercontent.standard+percN.standard+meanSLA.standard|variable),  data    =hem.2014.long,   family    =poisson)
anova(mod1,mod2,mod.leaf.2)
# keep morphotype

# model without N, with other predictors
mod3    =glmer(value    ~percP.standard+meanWatercontent.standard +morphotype +meanSLA.standard +(1+percP.standard+meanWatercontent.standard+morphotype+meanSLA.standard|variable),  data    =hem.2014.long,   family    =poisson)

# full model:
mod4    =glmer(value    ~percP.standard+meanWatercontent.standard +morphotype +meanSLA.standard+percN.standard +(1+percP.standard+meanWatercontent.standard+morphotype+meanSLA.standard+percN.standard|variable),  data    =hem.2014.long,   family    =poisson)
anova(mod3,mod1,mod4)
# full model is best

mod5    =glmer(value    ~percP.standard +morphotype +meanSLA.standard+percN.standard +(1+percP.standard+morphotype+meanSLA.standard+percN.standard|variable),  data    =hem.2014.long,   family    =poisson)
mod6    =glmer(value    ~meanWatercontent.standard +morphotype +meanSLA.standard+percN.standard +(1+meanWatercontent.standard+morphotype+meanSLA.standard+percN.standard|variable),  data    =hem.2014.long,   family    =poisson)
mod7    =glmer(value    ~meanWatercontent.standard +morphotype +percN.standard +(1+meanWatercontent.standard+morphotype+percN.standard|variable),  data    =hem.2014.long,   family    =poisson)
mod8    =glmer(value    ~percP.standard+meanWatercontent.standard  +meanSLA.standard+percN.standard +(1+percP.standard+meanWatercontent.standard+meanSLA.standard+percN.standard|variable),  data    =hem.2014.long,   family    =poisson)

anova(mod4,mod5,mod6,mod3,mod7,mod8)
# mod4 is best- ie full model. 

mod9    =glmer(value    ~percP.standard+morphotype +(1+percP.standard+morphotype|variable),  data    =hem.2014.long,   family    =poisson)

summary(mod4)
# important predictors are phorphorus and morphotype

## Full model is best, sig predictors in full model are phosphorus and morphotype. 
# species specific intercepts explain much better
#


dotplot(ranef(mod4,condVar=T))
# look at dotplot on a leaftrait by leaftrait basis

mod    =glmer(value    ~percP.standard +(1+percP.standard|variable),  data    =hem.2014.long,   family    =poisson)
dotplot(ranef(mod,condVar=T))
mod    =glmer(value    ~percN.standard +(1+percN.standard|variable),  data    =hem.2014.long,   family    =poisson)
dotplot(ranef(mod,condVar=T))
mod    =glmer(value    ~meanSLA.standard +(1+meanSLA.standard|variable),  data    =hem.2014.long,   family    =poisson)
dotplot(ranef(mod,condVar=T))
mod    =glmer(value    ~meanWatercontent.standard +(1+meanWatercontent.standard|variable),  data    =hem.2014.long,   family    =poisson)
dotplot(ranef(mod,condVar=T))
mod    =glmer(value    ~morphotype +(1+morphotype|variable),  data    =hem.2014.long,   family    =poisson)
dotplot(ranef(mod,condVar=T))



hemlong<-hem.2014.long[hem.2014.long$variable==c("GRE_PSI"),]
hemlong<-rbind(hemlong,hem.2014.long[hem.2014.long$variable==c("OCE_VUL"),])
hemlong<-rbind(hemlong,hem.2014.long[hem.2014.long$variable==c("OPU_SP"),])
hemlong<-rbind(hemlong,hem.2014.long[hem.2014.long$variable==c("LEI_SP"),])
hemlong<-rbind(hemlong,hem.2014.long[hem.2014.long$variable==c("ORT_MET"),])
hemlong<-rbind(hemlong,hem.2014.long[hem.2014.long$variable==c("KOA_HAW"),])
hemlong<-rbind(hemlong,hem.2014.long[hem.2014.long$variable==c("SAR_ADO"),])
hemlong<-rbind(hemlong,hem.2014.long[hem.2014.long$variable==c("GEO_SP"),])
hemlong<-rbind(hemlong,hem.2014.long[hem.2014.long$variable==c("PAR_PYR"),])
hemlong<-rbind(hemlong,hem.2014.long[hem.2014.long$variable==c("TYM_TYM"),])




ggplot(data=hemlong, aes(x=percN.standard, y=log(value), group=variable, colour=variable)) +
#    geom_point()+
  geom_smooth(method=lm, se=F,level=0.95)+
  ylab("Abundance")+ xlab("standardized foliar nitrogen %")

ggplot(data=hemlong, aes(x=percP.standard, y=log(value), group=variable, colour=variable)) +
 #   geom_point()+
  geom_smooth(method=lm, se=F,level=0.95)+
    ylab("Abundance")+ xlab("standardized foliar phosphorus %")

ggplot(data=hemlong, aes(x=meanSLA.standard, y=log(value), group=variable, colour=variable)) +
#    geom_point()+
  geom_smooth(method=lm, se=F,level=0.95)+
    ylab("Abundance")+ xlab("standardized mean specific leaf area")

ggplot(data=hemlong, aes(x=meanWatercontent.standard, y=log(value), group=variable, colour=variable)) +
#    geom_point()+
  geom_smooth(method=lm, se=F,level=0.95)+
    ylab("Abundance")+ xlab("standardized mean water content")




#
```





## Conclusions
<br>
<br>

##### (i) How do herbivore communities respond to phenotypic variation?
There is variation in species composition across sites and metrosideros traits. NMDS plots indicate differences between sites and volcanoes in species composition. 

##### (ii) Which plant traits account for herbivore community responses to host-plant phenotype?
CCA results point to the importance of foliar nitrogen, leaf morphotype and specific leaf area. However, there is still a large part of variation not explained. 

##### (iii) Which insect traits account for herbivore community responses to host-plant phenotype
Community composition varies across metrosideros traits. Feeding guild is correlated with foliar %N, where leaf chewers (sig) and sap feeders (NS) are more abundant on higher nutrient trees. Feeding guild is correlated with morphotype, where high trichome density morphotype is correlated with higher abundance gallers and seed feeders, and lower abundances of chewers and sap feeders. Morphotype is positively correlated with proportion specialists (pubescent leaves show relatively higher abundances of specialists). Location of the nymph varies little across morphotypes, 



<br>






